# 🎯 Test_Mod 販售版功能控制指南

## 📋 概述

本系統參考 FanFan 專案架構，提供基於資料庫的功能開關機制，讓您可以針對不同群組控制可用功能，適合對外販售時進行功能分級管理。

## 🔧 系統特色

- ✅ **資料庫儲存模式**：所有設定存於資料庫，永久保存
- ✅ **功能拆分設計**：12 種可獨立控制的功能模組
- ✅ **中文化指令**：全面使用中文指令，更符合台灣用戶習慣
- ✅ **TOKEN 驗證**：每個群組獨立 TOKEN，可用於 API 驗證
- ✅ **方案管理**：預設 4 種方案，可快速套用
- ✅ **使用統計**：記錄功能使用情況，方便分析

## 🎨 可控制的功能列表

| 功能代碼 | 功能名稱 | 說明 |
|---------|---------|------|
| `verify` | 驗證功能 | LINE 用戶身份驗證系統 |
| `report` | 回報文功能 | 回報文提交與管理 |
| `coupon` | 抽獎券功能 | 抽獎券查詢與管理 |
| `draw` | 每日抽獎 | 每日抽獎活動 |
| `wallet` | 儲值錢包 | 儲值金錢包系統 |
| `admin_panel` | 管理面板 | Web 管理後台入口 |
| `schedule` | 預約系統 | 預約排程功能 |
| `wage` | 薪資管理 | 薪資計算與查詢 |
| `manual_verify` | 手動驗證 | 手動驗證審核 |
| `richmenu` | 圖文選單 | LINE 圖文選單管理 |
| `statistics` | 統計功能 | 數據統計與報表 |
| `ad_menu` | 廣告專區 | 廣告展示功能 |

## 📦 預設方案設定

### 🔹 基礎版 (basic)
```
包含功能：驗證、回報文、抽獎券
適用場景：入門用戶、試用版本
```

### 🔸 標準版 (standard)
```
包含功能：驗證、回報文、抽獎券、每日抽獎、儲值錢包
適用場景：一般商家、小型店家
```

### 🔶 專業版 (professional)
```
包含功能：標準版 + 管理面板、預約系統
適用場景：中型店家、需要預約管理
```

### ⭐ 企業版 (enterprise)
```
包含功能：全部功能
適用場景：大型商家、完整需求
```

## 🎯 管理員指令

### 1. 查看群組功能狀態
```
/功能設定
```
顯示：
- 當前啟用的功能列表
- 群組專屬 TOKEN
- 授權到期日（如有設定）
- 最後更新時間

### 2. 開啟/關閉個別功能
```
/設定功能 <功能代碼>
```
範例：
- `/設定功能 verify` - 切換驗證功能
- `/設定功能 draw` - 切換每日抽獎
- `/設定功能 wallet` - 切換儲值錢包

### 3. 設定功能方案
```
/設定方案 <方案名稱>
```
範例：
- `/設定方案 basic` - 套用基礎版
- `/設定方案 standard` - 套用標準版
- `/設定方案 professional` - 套用專業版
- `/設定方案 enterprise` - 套用企業版

### 4. 生成群組 TOKEN
```
/生成token
```
功能：
- 為群組生成唯一的 TOKEN
- 已有設定會重新生成新 TOKEN
- 可用於 API 驗證或功能授權

## 📱 使用流程

### 情境 1：新群組初始設定

1. **機器人加入群組**
   - 預設啟用所有功能（完整體驗）

2. **查看當前狀態**
   ```
   /功能設定
   ```

3. **設定適合的方案**
   ```
   /設定方案 standard
   ```

4. **生成專屬 TOKEN**
   ```
   /生成token
   ```

### 情境 2：販售不同方案

#### 客戶 A - 購買基礎版
```
/設定方案 basic
```
系統自動設定：驗證、回報文、抽獎券

#### 客戶 B - 購買專業版
```
/設定方案 professional
```
系統自動設定：完整功能包含預約系統

#### 客戶 C - 客製化需求
```
/設定方案 standard          # 先套用標準版
/設定功能 statistics       # 額外開啟統計功能
/設定功能 ad_menu          # 額外開啟廣告專區
```

### 情境 3：功能試用與升級

#### 提供試用（限制功能）
```
/設定方案 basic            # 基礎版試用
```

#### 升級到正式版
```
/設定方案 professional     # 升級專業版
```

#### 臨時關閉特定功能
```
/設定功能 draw             # 暫時關閉抽獎
```

## 🔐 權限說明

- **ADMIN_IDS（管理員）**: 可執行所有功能管理指令
- **一般用戶**: 受限於群組啟用的功能
- **功能檢查**: 每個功能執行前自動檢查授權

## 💾 資料庫結構

### GroupFeatureSetting（群組功能設定）
```python
- group_id: 群組 ID
- token: 專屬 TOKEN
- features: JSON 格式功能列表
- expires_at: 授權到期日
- is_active: 是否啟用
- created_at: 建立時間
- updated_at: 更新時間
```

### CommandConfig（指令配置）
```python
- command_key: 功能鍵值
- command_zh: 中文指令
- command_en: 英文指令
- feature_category: 功能分類
- is_admin_only: 是否管理員專用
```

### FeatureUsageLog（使用記錄）
```python
- group_id: 群組 ID
- user_id: 用戶 ID
- feature_key: 使用的功能
- command_used: 使用的指令
- created_at: 使用時間
```

## 🚀 部署步驟

### 1. 執行資料庫遷移
```bash
flask db upgrade
```

### 2. 初始化指令配置（首次部署）
```python
from utils.feature_control import init_command_config
init_command_config()
```

### 3. 設定管理員 ID
在 [storage.py](storage.py) 中設定：
```python
ADMIN_IDS = {'U5ce6c382...', 'U2bcd6300...'}
```

### 4. 測試功能
1. 讓機器人加入測試群組
2. 執行 `/功能設定` 確認系統正常
3. 測試功能開關切換
4. 驗證功能控制是否生效

## 📊 功能使用統計

系統自動記錄每次功能使用：
- 哪個群組使用
- 哪個用戶使用
- 使用了什麼功能
- 使用時間

可用於：
- 分析熱門功能
- 統計使用頻率
- 優化功能設計
- 客戶使用報告

## ⚠️ 注意事項

1. **管理員權限**：只有 `ADMIN_IDS` 中的用戶可以執行管理指令
2. **TOKEN 保密**：群組 TOKEN 請妥善保管，可用於 API 驗證
3. **功能依賴**：某些功能可能互相依賴，關閉時請注意
4. **授權到期**：可設定 `expires_at` 實現時間限制
5. **資料備份**：定期備份資料庫，避免設定遺失

## 🔄 升級與維護

### 新增功能時
1. 在 `FEATURE_LIST` 新增功能定義
2. 在 `init_command_config` 新增指令配置
3. 在相關處理器加入功能檢查
4. 更新文件說明

### 調整方案時
修改 `FEATURE_CATEGORIES` 中的方案定義：
```python
FEATURE_CATEGORIES = {
    "basic": ["verify", "report", "coupon"],
    "custom": ["verify", "draw", "wallet", "statistics"],
    # 自訂方案...
}
```

## 📞 技術支援

如有問題請參考：
- [部署檢查清單](DEPLOYMENT_CHECKLIST.md)
- [配置範例](CONFIGURATION_EXAMPLES.md)
- [更新日誌](CHANGELOG.md)

---

**系統版本**: v2.0 販售版  
**最後更新**: 2026-01-08  
**參考專案**: FanFan Feature Control System
