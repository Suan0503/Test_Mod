<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ‰£æ¬¾å°å¸³</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Zen Maru Gothic','å¾®è»Ÿæ­£é»‘é«”',sans-serif;background:#f7f9fb;margin:0;color:#333}
    .header{padding:20px;text-align:center;background:#fff3e0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .header a{display:inline-block;margin:6px 8px;background:#fb8c00;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-size:.85rem}
    .container{max-width:1200px;margin:24px auto;padding:0 18px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    table{width:100%;border-collapse:collapse;font-size:.85rem}
    th,td{border-bottom:1px solid #e0e0e0;padding:8px 10px;text-align:left}
    thead tr{background:#ef6c00;color:#fff}
    tr:hover{background:#fafafa}
    .summary{display:flex;gap:14px;flex-wrap:wrap}
    .pill{background:#fff3e0;color:#e65100;border-radius:999px;padding:6px 10px;font-size:.85rem}
    input,select{padding:8px 10px;border:1px solid #cfd8dc;border-radius:8px}
    button{background:#ef6c00;border:none;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  </style>
  </head>
<body>
  <div class="header">
    <h2>ğŸ§¾ æ‰£æ¬¾å°å¸³</h2>
    <a href="/admin/wallet/reconcile">å„²å€¼å°å¸³</a>
    <a href="/admin/wallet">å–®ä¸€æŸ¥è©¢</a>
    <a href="/admin/home">å›å¾Œå°ä¸»é </a>
  </div>
  <div class="container">
    <div class="card">
      <div class="summary">
        <div class="pill">æœ¬æ—¥æ™‚æ®µç¸½é¡(12:00~ç¿Œæ—¥03:00)ï¼š<b>{{ today_total }}</b></div>
        <div class="pill">ç­†æ•¸ï¼š<b>{{ count }}</b></div>
        <div class="pill">ç¸½é¡ï¼š<b>{{ total_amount }}</b></div>
        <div class="pill">å¹³å‡ï¼š<b>{{ avg_amount }}</b></div>
        <div class="pill">æŸ¥è©¢å€é–“ï¼š{{ start_local_display }} ~ {{ end_local_display }}</div>
      </div>
      <form method="get" action="/admin/wallet/consume/reconcile" style="display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap">
        <label>å¿«é€Ÿå€é–“</label>
        <select name="preset" onchange="this.form.submit()">
          <option value="">è‡ªè¨‚</option>
          <option value="today" {% if preset=='today' %}selected{% endif %}>ä»Šæ—¥</option>
          <option value="yesterday" {% if preset=='yesterday' %}selected{% endif %}>æ˜¨æ—¥</option>
          <option value="thisweek" {% if preset=='thisweek' %}selected{% endif %}>æœ¬é€±</option>
          <option value="thismonth" {% if preset=='thismonth' %}selected{% endif %}>æœ¬æœˆ</option>
        </select>
        <label>èµ·</label>
        <input type="date" name="start" value="{{ start or '' }}" />
        <label>è¿„</label>
        <input type="date" name="end" value="{{ end or '' }}" />
        <button type="submit">æŸ¥è©¢</button>
        <a class="button" href="/admin/wallet/consume/reconcile?start={{ start or '' }}&end={{ end or '' }}&export=csv" style="text-decoration:none"><button type="button">åŒ¯å‡º CSV</button></a>
      </form>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">æ˜ç´°</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>æ™‚é–“(å°åŒ—)</th>
            <th>æ‰‹æ©Ÿ</th>
            <th>åç¨±</th>
            <th>ç·¨è™Ÿ</th>
            <th>é‡‘é¡</th>
            <th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.time }}</td>
            <td>
              {% if r.phone and r.phone != 'â€”' %}
                <a href="/admin/wallet?q={{ r.phone }}" style="color:#ef6c00;text-decoration:none">{{ r.phone }}</a>
              {% else %}
                â€”
              {% endif %}
            </td>
            <td>{{ r.nickname }}</td>
            <td>{{ r.code }}</td>
            <td>{{ r.amount }}</td>
            <td>{{ r.remark }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">ä¾æ—¥æœŸ(æ—¥)å½™ç¸½</h3>
      <table>
        <thead><tr><th>æ—¥æœŸ</th><th>é‡‘é¡</th></tr></thead>
        <tbody>
          {% for d,amt in by_day.items() %}
          <tr><td>{{ d }}</td><td>{{ amt }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>