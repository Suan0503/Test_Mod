<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å„²å€¼å°å¸³</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Zen Maru Gothic','å¾®è»Ÿæ­£é»‘é«”',sans-serif;background:#f7f9fb;margin:0;color:#333}
    .header{padding:20px;text-align:center;background:#e3f2fd;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .header a{display:inline-block;margin:6px 8px;background:#2196f3;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-size:.85rem}
    .container{max-width:1200px;margin:24px auto;padding:0 18px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    table{width:100%;border-collapse:collapse;font-size:.85rem}
    th,td{border-bottom:1px solid #e0e0e0;padding:8px 10px;text-align:left}
    thead tr{background:#1976d2;color:#fff}
    tr:hover{background:#fafafa}
    .summary{display:flex;gap:14px;flex-wrap:wrap}
    .pill{background:#e3f2fd;color:#0d47a1;border-radius:999px;padding:6px 10px;font-size:.85rem}
    input,select{padding:8px 10px;border:1px solid #cfd8dc;border-radius:8px}
    button{background:#1976d2;border:none;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .danger{background:#e57373}
    .muted{color:#607d8b}
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ“’ å„²å€¼å°å¸³</h2>
    <a href="/admin/wallet/summary">å„²å€¼é‡‘ç¸½è¡¨</a>
    <a href="/admin/wallet">å–®ä¸€æŸ¥è©¢</a>
    <a href="/admin/home">å›å¾Œå°ä¸»é </a>
  </div>
  <div class="container">
    <div class="card">
      <div class="summary">
        <div class="pill">æœ¬æ—¥æ™‚æ®µç¸½é¡(12:00~ç¿Œæ—¥03:00)ï¼š<b>{{ today_total }}</b></div>
        <div class="pill muted">æŸ¥è©¢å€é–“ï¼š{{ start_local_display }} ~ {{ end_local_display }}</div>
        <div class="pill">ç­†æ•¸ï¼š<b>{{ count }}</b></div>
        <div class="pill">ç¸½é¡ï¼š<b>{{ total_amount }}</b></div>
        <div class="pill">å¹³å‡ï¼š<b>{{ avg_amount }}</b></div>
        <div class="pill" title="ä¾å‚™è¨»é—œéµå­—ï¼ˆä¾‹å¦‚ TOPUP_CASH, ç¾é‡‘ï¼‰åˆ¤æ–·">ç¾é‡‘æ‡‰æ”¶ï¼š<b>{{ cash_total }}</b>ï¼ˆ{{ cash_count }} ç­†ï¼‰</div>
  <div class="pill" title="æœ¬æŸ¥è©¢æœŸé–“æœƒå“¡æ‰£æ¬¾ç¸½é¡">æ”¯å‡ºï¼š<b>{{ consume_total }}</b>ï¼ˆ{{ consume_count }} ç­†ï¼‰</div>
      </div>
      <form method="get" action="/admin/wallet/reconcile" style="display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap">
        <label>å¿«é€Ÿå€é–“</label>
        <select name="preset" onchange="this.form.submit()">
          <option value="">è‡ªè¨‚</option>
          <option value="today" {% if preset=='today' %}selected{% endif %}>ä»Šæ—¥</option>
          <option value="yesterday" {% if preset=='yesterday' %}selected{% endif %}>æ˜¨æ—¥</option>
          <option value="thisweek" {% if preset=='thisweek' %}selected{% endif %}>æœ¬é€±</option>
          <option value="thismonth" {% if preset=='thismonth' %}selected{% endif %}>æœ¬æœˆ</option>
        </select>
        <label>èµ·</label>
        <input type="date" name="start" value="{{ start or '' }}" />
        <label>è¿„</label>
        <input type="date" name="end" value="{{ end or '' }}" />
        <label>ç¾é‡‘é—œéµå­—</label>
        <input type="text" name="cash_kw" value="{{ cash_kw or '' }}" placeholder="TOPUP_CASH,ç¾é‡‘" />
        <button type="submit">æŸ¥è©¢</button>
        <a class="button" href="/admin/wallet/reconcile?start={{ start or '' }}&end={{ end or '' }}&cash_kw={{ cash_kw or '' }}&export=csv" style="text-decoration:none"><button type="button">åŒ¯å‡º CSV</button></a>
      </form>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">æ˜ç´°</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>æ™‚é–“(å°åŒ—)</th>
            <th>æ‰‹æ©Ÿ</th>
            <th>åç¨±</th>
            <th>ç·¨è™Ÿ</th>
            <th>é‡‘é¡</th>
            <th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.time }}</td>
            <td>
              {% if r.phone and r.phone != 'â€”' %}
                <a href="/admin/wallet?q={{ r.phone }}" style="color:#1976d2;text-decoration:none">{{ r.phone }}</a>
              {% else %}
                â€”
              {% endif %}
            </td>
            <td>{{ r.nickname }}</td>
            <td>{{ r.code }}</td>
            <td>{{ r.amount }}</td>
            <td>{{ r.remark }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">å•é¡Œç´€éŒ„</h3>
      <div style="display:flex;gap:24px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <h4 style="margin:4px 0">ç„¡æ•ˆï¼ˆç„¡é›»è©±ï¼‰</h4>
          <p style="margin:4px 0;font-size:.75rem;color:#666">æ¢ä»¶ï¼šé›»è©±ç‚ºç©ºä¸”é‡‘é¡>0 ä¸”å‚™è¨»å«ã€å„²å€¼ã€æˆ– TOPUP_CASHã€‚å¯è€ƒæ…®è‡ªå‹•æ¸…ç†ã€‚</p>
          <a href="/admin/wallet/reconcile?clean_invalid=1" style="text-decoration:none"><button type="button" class="danger">è‡ªå‹•æ¸…ç†</button></a>
          <table style="margin-top:8px">
            <thead><tr><th>ID</th><th>æ™‚é–“</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th></th></tr></thead>
            <tbody>
              {% for r in invalid_rows %}
              <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.time }}</td>
                <td>{{ r.amount }}</td>
                <td>{{ r.remark }}</td>
                <td>
                  <form method="post" action="/admin/wallet/txn/delete" style="margin:0">
                    <input type="hidden" name="id" value="{{ r.id }}" />
                    <input type="hidden" name="q" value="" />
                    <input type="hidden" name="redirect_url" value="/admin/wallet/reconcile" />
                    <button type="submit" class="danger" style="padding:4px 8px;font-size:.7rem" onclick="return confirm('åˆªé™¤æ­¤ç„¡æ•ˆäº¤æ˜“ï¼Ÿ')">åˆªé™¤</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div style="flex:1;min-width:260px">
          <h4 style="margin:4px 0">é‡è¤‡ï¼ˆåŒæ‰‹æ©Ÿ+é‡‘é¡+å‚™è¨»ï¼‰</h4>
          <p style="margin:4px 0;font-size:.75rem;color:#666">åƒ…åˆ—å‡ºéœ€åˆªé™¤çš„é‡è¤‡ç­†ï¼ˆä¿ç•™ç¬¬ä¸€ç­†ï¼‰ã€‚</p>
          <table style="margin-top:8px">
            <thead><tr><th>ID</th><th>æ‰‹æ©Ÿ</th><th>æ™‚é–“</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th></th></tr></thead>
            <tbody>
              {% for r in duplicate_rows %}
              <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.phone }}</td>
                <td>{{ r.time }}</td>
                <td>{{ r.amount }}</td>
                <td>{{ r.remark }}</td>
                <td>
                  <form method="post" action="/admin/wallet/txn/delete" style="margin:0">
                    <input type="hidden" name="id" value="{{ r.id }}" />
                    <input type="hidden" name="q" value="{{ r.phone }}" />
                    <input type="hidden" name="redirect_url" value="/admin/wallet/reconcile" />
                    <button type="submit" class="danger" style="padding:4px 8px;font-size:.7rem" onclick="return confirm('åˆªé™¤æ­¤é‡è¤‡äº¤æ˜“ï¼Ÿ')">åˆªé™¤</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">å½™ç¸½</h3>
      <div style="display:flex;gap:20px;flex-wrap:wrap">
        <div>
          <h4 style="margin:4px 0">ä¾å‚™è¨»</h4>
          <table>
            <thead><tr><th>å‚™è¨»</th><th>ç­†æ•¸</th><th>é‡‘é¡</th></tr></thead>
            <tbody>
              {% for k,v in by_remark.items() %}
              <tr><td>{{ k }}</td><td>{{ v.count }}</td><td>{{ v.amount }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:4px 0">ä¾æ—¥æœŸ(æ—¥)</h4>
          <table>
            <thead><tr><th>æ—¥æœŸ</th><th>é‡‘é¡</th></tr></thead>
            <tbody>
              {% for d,amt in by_day.items() %}
              <tr><td>{{ d }}</td><td>{{ amt }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
