{% extends 'admin_custom_master.html' %}

{% block title %}Rich Menu 圖片更新{% endblock %}

{% block header_card %}
<div class="card p-4 mb-4">
	<h2 class="mb-2 font-weight-bold" style="color:#2d3a4b;"><i class="fa fa-image"></i> Rich Menu 圖片更新專用頁面</h2>
	<p class="mb-0" style="color:#555;">此頁面僅提供 LINE Rich Menu 圖片上傳與預覽，不包含其他後台功能。</p>
</div>
{% endblock %}

{% block body %}
<div class="container py-4">
	<div class="mb-3">
		<a href="{{ url_for('admin.home') }}" class="btn btn-outline-secondary btn-sm">← 回管理首頁</a>
	</div>

	<div class="card shadow-sm mb-3">
		<div class="card-body">
			<h3 class="h5 mb-2">LINE Rich Menu 圖片更新</h3>
			<p class="text-muted mb-0">
				在此輸入 Rich Menu ID 並選擇圖片，上傳後系統會直接呼叫 LINE Messaging API 更新該 Rich Menu 的圖片，
				檔案只會暫存在記憶體中，不會寫入伺服器磁碟。
			</p>
		</div>
	</div>

	{% with messages = get_flashed_messages(with_categories=true) %}
		{% if messages %}
			{% for category, message in messages %}
				<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			{% endfor %}
		{% endif %}
	{% endwith %}

	<div class="card shadow-sm mb-3">
		<div class="card-body">
			<form method="post" enctype="multipart/form-data">
				<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

				<div class="mb-3">
					<label for="rich_menu_id" class="form-label">Rich Menu ID</label>
					<input type="text" class="form-control" id="rich_menu_id" name="rich_menu_id"
								 placeholder="請貼上從 LINE 後台或 API 取得的 Rich Menu ID" required>
				</div>

				<div class="mb-3">
					<label for="image" class="form-label">選擇圖片</label>
					<input class="form-control" type="file" id="image" name="image" accept="image/*" required>
					<div class="form-text">
						建議使用 LINE 官方建議尺寸的 PNG 或 JPEG 圖片，檔案大小請控制在 10MB 以內。
					</div>
				</div>

				<div class="mb-3" id="preview-wrapper" style="display:none;">
					<label class="form-label">預覽</label>
					<div class="border rounded p-2 bg-light">
						<img id="preview-image" src="" alt="Rich Menu 預覽" style="max-width:100%; border-radius:8px;" />
					</div>
				</div>

				<button type="submit" class="btn btn-primary">
					上傳並更新 Rich Menu 圖片
				</button>
			</form>
		</div>
	</div>

	<div class="card shadow-sm">
		<div class="card-body">
			<h5 class="h6 mb-3">目前 LINE 帳號的 Rich Menu 清單</h5>
			{% if richmenus_error %}
				<div class="alert alert-warning mb-0">{{ richmenus_error }}</div>
			{% elif richmenus and richmenus|length > 0 %}
				<div class="table-responsive">
					<table class="table table-sm align-middle mb-0">
						<thead class="table-light">
							<tr>
								<th scope="col">Rich Menu ID</th>
								<th scope="col">名稱 / chatBarText</th>
								<th scope="col">尺寸</th>
								<th scope="col" style="width: 110px;">操作</th>
							</tr>
						</thead>
						<tbody>
							{% for m in richmenus %}
								<tr>
									<td style="font-size: 0.8rem; word-break: break-all;">{{ m.richMenuId }}</td>
									<td>
										<div class="fw-semibold">{{ m.name or '（未命名）' }}</div>
										<div class="text-muted" style="font-size: 0.8rem;">{{ m.chatBarText or '' }}</div>
									</td>
									<td style="font-size: 0.8rem;">
										{% if m.size %}{{ m.size.width }} × {{ m.size.height }}{% else %}—{% endif %}
									</td>
									<td>
										<button type="button" class="btn btn-outline-primary btn-sm" onclick="fillRichMenuId('{{ m.richMenuId }}')">帶入上方</button>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			{% else %}
				<div class="text-muted">目前此 LINE 帳號下沒有任何 Rich Menu。</div>
			{% endif %}
		</div>
	</div>
</div>

<script>
	(function() {
		const input = document.getElementById('image');
		const previewWrapper = document.getElementById('preview-wrapper');
		const previewImage = document.getElementById('preview-image');
		if (!input || !previewWrapper || !previewImage) return;

		input.addEventListener('change', function (e) {
			const file = this.files && this.files[0];
			if (!file) {
				previewWrapper.style.display = 'none';
				previewImage.src = '';
				return;
			}
			if (!file.type || file.type.indexOf('image/') !== 0) {
				alert('請選擇圖片檔案');
				this.value = '';
				previewWrapper.style.display = 'none';
				previewImage.src = '';
				return;
			}
			const url = URL.createObjectURL(file);
			previewImage.src = url;
			previewWrapper.style.display = 'block';
		});
	})();

	function fillRichMenuId(id) {
		var input = document.getElementById('rich_menu_id');
		if (!input) return;
		input.value = id;
		input.focus();
		window.scrollTo({ top: 0, behavior: 'smooth' });
	}
</script>

{% endblock %}

