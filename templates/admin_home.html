<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>後台主頁</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans TC','微軟正黑體',sans-serif;
      background: #f4f6f9;
      margin: 0;
      color: #333;
    }
    a { color: inherit; text-decoration: none; }
    .page-header {
      background: linear-gradient(135deg,#4f8cff,#38c6ff);
      color: #fff;
      padding: 18px 20px 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    }
    .page-header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .page-title {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.08em;
    }
    .page-subtitle {
      font-size: .95rem;
      opacity: .9;
    }
    .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .nav-link-btn {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      color: #fff;
      font-size: .9rem;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.25);
      cursor: pointer;
      transition: background .15s, transform .15s, box-shadow .15s;
    }
    .nav-link-btn:hover {
      background: rgba(255,255,255,0.22);
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
      transform: translateY(-1px);
    }
    .nav-link-btn.primary {
      background: #fff;
      color: #2563eb;
    }
    .wrapper {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }
    .flash-wrapper {
      margin-bottom: 12px;
    }
    .flash {
      background: #fff;
      padding: 10px 14px;
      margin-bottom: 8px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(15,23,42,0.06);
      font-size: .9rem;
      border-left: 4px solid #60a5fa;
    }
    .flash-success { border-left-color:#22c55e; }
    .flash-danger  { border-left-color:#ef4444; }
    .flash-warning { border-left-color:#f59e0b; }
    .flash-info    { border-left-color:#60a5fa; }

    .section-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(15,23,42,0.06);
      padding: 18px 18px 20px;
      margin-bottom: 18px;
    }
    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2563eb;
    }
    .section-note {
      font-size: .8rem;
      color: #6b7280;
    }
    .section-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 2fr);
      gap: 18px;
    }
    .section-body.single {
      grid-template-columns: minmax(0,1fr);
    }
    @media (max-width: 840px) {
      .section-body { grid-template-columns: minmax(0,1fr); }
    }

    .block-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px 12px 14px;
      border: 1px solid #e5e7eb;
    }
    .block-title {
      font-size: .9rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }
    .form-row input[type="text"] {
      flex: 1 1 140px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: .9rem;
    }
    .btn-pill {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: .88rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg,#4f8cff,#38c6ff);
      color: #fff;
      box-shadow: 0 1px 4px rgba(15,23,42,0.15);
      transition: transform .15s, box-shadow .15s, opacity .15s;
    }
    .btn-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(15,23,42,0.18);
    }
    .btn-pill.danger {
      background: linear-gradient(135deg,#ef4444,#f97316);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .86rem;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }
    thead {
      background: #eff6ff;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) { background: #fafafa; }
    tbody tr:hover { background: #f1f5f9; }
    .status-pending { color:#f59e0b;font-weight:600; }
    .status-verified { color:#22c55e;font-weight:600; }
    .status-failed { color:#ef4444;font-weight:600; }
    .table-wrapper {
      max-height: 420px;
      overflow: auto;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(15,23,42,0.06);
    }
    .footer {
      text-align: center;
      font-size: .8rem;
      color: #9ca3af;
      margin-top: 28px;
    }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="page-header-inner">
      <div>
        <div class="page-title">後台主頁</div>
        <div class="page-subtitle">快速管理白名單 / 黑名單 / 待驗證名單</div>
      </div>
      <nav class="nav-links">
        <a href="{{ url_for('admin.home') }}" class="nav-link-btn primary">回首頁</a>
        <a href="{{ url_for('admin.wallet_home') }}" class="nav-link-btn">儲值金專區</a>
        <a href="{{ url_for('admin.wage_reconcile') }}" class="nav-link-btn">對帳工具</a>
        <a href="#whitelist" class="nav-link-btn">白名單</a>
        <a href="#blacklist" class="nav-link-btn">黑名單</a>
        <a href="#pending" class="nav-link-btn">待驗證名單</a>
      </nav>
    </div>
  </header>

  <main class="wrapper">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      <div class="flash-wrapper">
        {% for category, msg in messages %}
          <div class="flash flash-{{ category }}">{{ msg }}</div>
        {% endfor %}
      </div>
      {% endif %}
    {% endwith %}

    <!-- 白名單 -->
    <section id="whitelist" class="section-card">
      <div class="section-header">
        <div class="section-title">白名單管理</div>
        <div class="section-note">最近 {{ limit }} 筆白名單記錄</div>
      </div>
      <div class="section-body">
        <div class="left">
          <div class="block-card" style="margin-bottom:10px;">
            <div class="block-title">搜尋白名單</div>
            <form method="get" action="/admin/whitelist/search" class="form-row">
              <input type="text" name="q" placeholder="手機 / LINE ID / 暱稱">
              <input type="hidden" name="view" value="home">
              <button type="submit" class="btn-pill">搜尋</button>
            </form>
          </div>
          <div class="block-card" style="margin-bottom:10px;">
            <div class="block-title">新增白名單</div>
            <form method="post" action="/admin/whitelist/add">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="form-row">
                <input type="text" name="phone" placeholder="手機 (09xxxxxxxx)" maxlength="10" required>
              </div>
              <div class="form-row">
                <input type="text" name="name" placeholder="暱稱" maxlength="30" required>
              </div>
              <div class="form-row">
                <input type="text" name="line_id" placeholder="LINE ID" maxlength="50" required>
              </div>
              <div class="form-row" style="justify-content:flex-end;margin-top:4px;">
                <button type="submit" class="btn-pill">新增白名單</button>
              </div>
            </form>
          </div>
          <div class="block-card">
            <div class="block-title">移除白名單</div>
            <form method="post" action="/admin/whitelist/delete">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="form-row">
                <input type="text" name="phone" placeholder="欲刪除的手機" maxlength="10" required>
                <button type="submit" class="btn-pill danger">刪除</button>
              </div>
            </form>
          </div>
        </div>
        <div class="right">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>手機</th>
                  <th>暱稱</th>
                  <th>LINE ID</th>
                  <th>加入日期</th>
                </tr>
              </thead>
              <tbody>
                {% for w in whitelists %}
                <tr>
                  <td>{{ w.phone }}</td>
                  <td>{{ w.name }}</td>
                  <td>{{ w.line_id }}</td>
                  <td>{{ w.created_at.strftime('%Y/%m/%d') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- 黑名單 -->
    <section id="blacklist" class="section-card">
      <div class="section-header">
        <div class="section-title">黑名單管理</div>
        <div class="section-note">最近 {{ limit }} 筆黑名單記錄</div>
      </div>
      <div class="section-body">
        <div class="left">
          <div class="block-card" style="margin-bottom:10px;">
            <div class="block-title">搜尋黑名單</div>
            <form method="get" action="/admin/blacklist/search" class="form-row">
              <input type="text" name="q" placeholder="手機 / 暱稱">
              <input type="hidden" name="view" value="home">
              <button type="submit" class="btn-pill">搜尋</button>
            </form>
          </div>
          <div class="block-card" style="margin-bottom:10px;">
            <div class="block-title">新增黑名單</div>
            <form method="post" action="/admin/blacklist/add">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="form-row">
                <input type="text" name="phone" placeholder="手機" maxlength="10" required>
              </div>
              <div class="form-row">
                <input type="text" name="name" placeholder="暱稱" maxlength="30" required>
              </div>
              <div class="form-row">
                <input type="text" name="reason" placeholder="原因" maxlength="50" required>
              </div>
              <div class="form-row" style="justify-content:flex-end;margin-top:4px;">
                <button type="submit" class="btn-pill danger">新增黑名單</button>
              </div>
            </form>
          </div>
          <div class="block-card">
            <div class="block-title">移除黑名單</div>
            <form method="post" action="/admin/blacklist/delete">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="form-row">
                <input type="text" name="phone" placeholder="欲刪除的手機" maxlength="10" required>
                <button type="submit" class="btn-pill danger">刪除</button>
              </div>
            </form>
          </div>
        </div>
        <div class="right">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>手機</th>
                  <th>暱稱</th>
                  <th>原因</th>
                  <th>加入日期</th>
                </tr>
              </thead>
              <tbody>
                {% for b in blacklists %}
                <tr>
                  <td>{{ b.phone }}</td>
                  <td>{{ b.name }}</td>
                  <td>{{ b.reason }}</td>
                  <td>{{ b.created_at.strftime('%Y/%m/%d') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- 待驗證名單 -->
    <section id="pending" class="section-card">
      <div class="section-header">
        <div class="section-title">待驗證名單</div>
        <div class="section-note">從 LINE Bot 收到、尚未審核的申請</div>
      </div>
      <div class="section-body single">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>手機</th>
                <th>LINE ID</th>
                <th>暱稱</th>
                <th>狀態</th>
                <th>建立日期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tempverifies %}
              <tr>
                <td>{{ t.phone }}</td>
                <td>{{ t.line_id }}</td>
                <td>{{ t.nickname }}</td>
                <td class="status-{{ t.status }}">{{ t.status }}</td>
                <td>{{ t.created_at.strftime('%Y/%m/%d') }}</td>
                <td>
                  <form method="post" action="/admin/tempverify/verify" style="display:inline-block;margin-right:4px;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="id" value="{{ t.id }}">
                    <button type="submit" class="btn-pill" style="padding:4px 10px;font-size:.8rem;">通過</button>
                  </form>
                  <form method="post" action="/admin/tempverify/delete" style="display:inline-block;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="id" value="{{ t.id }}">
                    <button type="submit" class="btn-pill danger" style="padding:4px 10px;font-size:.8rem;">刪除</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <div class="footer">&copy; 2025 後台管理 | 主頁快速操作</div>
  </main>
  <script>
    window.addEventListener('load', function () {
      var tab = '{{ active_tab or "" }}'.trim();
      if (tab) {
        var target = document.getElementById(tab);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    });
  </script>
</body>
</html>
