# app.py
# -*- coding: utf-8 -*-
import os
import re
import sqlite3
from datetime import datetime
from flask import Flask, request, redirect, url_for, render_template_string, flash

APP_TITLE = "èŒ—æ®¿å°ˆç”¨æŸ¥è©¢ç³»çµ±"
DB_PATH = os.path.join(os.path.dirname(__file__), "md_checker.db")

app = Flask(__name__)
app.secret_key = "change-me-please"  # è¨˜å¾—æ›æ‰å‘¦ï½

# ---------- è³‡æ–™åº«åˆå§‹åŒ– ----------
def get_conn():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_conn()
    c = conn.cursor()
    c.execute("""
        CREATE TABLE IF NOT EXISTS records (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            phone TEXT NOT NULL,
            line_id TEXT,
            type TEXT NOT NULL CHECK (type IN ('white','black')),
            reason TEXT,
            operator TEXT,
            created_at TEXT NOT NULL,
            updated_at TEXT NOT NULL
        )
    """)
    c.execute("CREATE INDEX IF NOT EXISTS idx_records_phone ON records(phone)")
    c.execute("CREATE INDEX IF NOT EXISTS idx_records_type ON records(type)")
    conn.commit()
    conn.close()

# ---------- å°å·¥å…· ----------
def normalize_phone(s: str) -> str:
    """åªä¿ç•™æ•¸å­—ï¼›09â€¦æˆ–+8869â€¦éƒ½è½‰æˆ0912â€¦æ ¼å¼"""
    if not s:
        return ""
    digits = re.sub(r"\D", "", s)
    # +886 é–‹é ­è™•ç† â†’ 09
    # å¸¸è¦‹ï¼š+886912345678 / 886912345678 / 00986â€¦ ç­‰
    digits = re.sub(r"^(886|00886|000886)", "", digits)
    if digits.startswith("9") and len(digits) == 9:
        digits = "0" + digits
    return digits

def validate_type(t: str) -> bool:
    return t in ("white", "black")

# ---------- æ¨¡æ¿ ----------
BASE_HTML = r"""
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>{{ title or 'ç³»çµ±' }}</title>
    <link rel="icon" href="/static/myicon.png">
    <style>
        :root{
            --brand:#7c4dff;
            --brand-d:#512da8;
            --bg1:#f6e9ff;
            --bg2:#c2e9fb;
        }
        *{box-sizing:border-box}
        body {
            font-family: "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
            color: #333;
            margin:0;
        }
        .container {
            max-width: 920px;
            margin: 40px auto 80px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px #c3a6e9;
            padding: 24px 28px;
        }
        h2,h3 {
            margin: 6px 0 10px 0;
            color: var(--brand);
            letter-spacing: 2px;
        }
        .topbar{
            display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px;
        }
        .nav a{
            text-decoration:none;padding:8px 12px;border-radius:8px;border:1px solid var(--brand);color:var(--brand);font-weight:700;margin-left:8px;
        }
        .nav a.active,.nav a:hover{background:var(--brand);color:#fff}
        label { font-weight: bold; font-size: 1.0em; }
        input[type="text"], select, textarea {
            width: 100%;
            font-size: 1em;
            padding: 9px 10px;
            border-radius: 8px;
            border: 1.5px solid var(--brand);
        }
        button {
            padding: 9px 18px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background: var(--brand);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: background .2s;
        }
        button:hover { background: var(--brand-d); }
        .btn-danger{background:#e53935}
        .btn-danger:hover{background:#b71c1c}
        .btn-secondary{background:#607d8b}
        .btn-secondary:hover{background:#455a64}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        .row-3{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:14px}
        .result { margin-top: 18px; }
        .white { color: green; font-weight: bold; }
        .black { color: red; font-weight: bold; }
        .none { color: #888; }
        .logo {
            display: block;
            width: 72px;
        }
        .card{border:1px solid #eee;border-radius:10px;padding:14px}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
        .flash{margin:8px 0;padding:10px;border-radius:8px;background:#f9f7ff;border:1px solid #d6c9ff;color:#4a2fbf}
        .muted{color:#777;font-size:0.92em}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ccc;font-size:12px;margin-left:4px}
        .pill.white{border-color:green;color:green}
        .pill.black{border-color:red;color:red}
        .actions{display:flex;gap:8px;flex-wrap:wrap}
        .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
        .footer{text-align:center;color:#777;margin-top:26px;font-size:12px}
    </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="/static/logo.png" alt="Logo" class="logo">
        <div>
          <div style="font-weight:800;color:#333;font-size:18px">{{ brand or 'èŒ—æ®¿' }}</div>
          <div class="muted">å°ˆç”¨æŸ¥è©¢èˆ‡å¾Œå°ç®¡ç†</div>
        </div>
      </div>
      <div class="nav">
        <a href="{{ url_for('index') }}" class="{{ 'active' if active=='index' else '' }}">æŸ¥è©¢</a>
        <a href="{{ url_for('admin') }}" class="{{ 'active' if active=='admin' else '' }}">å¾Œå°åˆ—è¡¨</a>
        <a href="{{ url_for('new_record') }}" class="{{ 'active' if active=='new' else '' }}">æ–°å¢è³‡æ–™</a>
      </div>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for m in messages %}
          <div class="flash">ğŸŒ¸ {{ m }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {{ body|safe }}

    <div class="footer">Â© {{ now.year }} {{ brand or 'èŒ—æ®¿' }} | å°å¹«æ‰‹ç³–ç³– à¸…^â€¢ï»Œâ€¢^à¸…</div>
  </div>
</body>
</html>
"""

INDEX_BODY = r"""
  <h2>èŒ—æ®¿å°ˆç”¨æŸ¥è©¢ç³»çµ±</h2>
  <div class="card">
    <form method="post">
      <div class="row">
        <div>
          <label for="phone">è«‹è¼¸å…¥é›»è©±</label>
          <input type="text" name="phone" id="phone" value="{{ phone }}" placeholder="ä¾‹å¦‚ 0912345678">
        </div>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button type="submit">æŸ¥è©¢</button>
          <a class="btn-secondary" style="text-decoration:none;padding:9px 14px;border-radius:8px;color:#fff" href="{{ url_for('index') }}">æ¸…é™¤</a>
        </div>
      </div>
    </form>

    <div class="result">
    {% if searched %}
        <hr>
        <h3>æŸ¥è©¢çµæœ</h3>
        {% if search_result %}
            {% for result in search_result %}
                {% if result.type == 'white' %}
                    <div class="white">
                        <b>ç™½åå–®</b>ï¼š{{ result.record.name }}ï¼ˆ{{ result.record.phone }}ï¼‰
                        {% if result.record.line_id %}ï¼ŒLINE ID: {{ result.record.line_id }}{% endif %}
                        {% if result.record.reason %}<br>åŸå› ï¼š{{ result.record.reason }}{% endif %}
                        <div class="muted">å»ºç«‹æ–¼ {{ result.record.created_at }}ï¼Œæœ€å¾Œæ›´æ–° {{ result.record.updated_at }}</div>
                    </div>
                {% elif result.type == 'black' %}
                    <div class="black">
                        <b>é»‘åå–®</b>ï¼š{{ result.record.name }}ï¼ˆ{{ result.record.phone }}ï¼‰
                        {% if result.record.reason %}<br>åŸå› ï¼š{{ result.record.reason }}{% endif %}
                        <div class="muted">å»ºç«‹æ–¼ {{ result.record.created_at }}ï¼Œæœ€å¾Œæ›´æ–° {{ result.record.updated_at }}</div>
                    </div>
                {% endif %}
                <hr>
            {% endfor %}
        {% else %}
            <div class="none">æŸ¥ç„¡æ­¤é›»è©±æ–¼ç™½/é»‘åå–®ã€‚</div>
        {% endif %}
    {% endif %}
    </div>
  </div>
"""

ADMIN_BODY = r"""
  <h2>å¾Œå°åˆ—è¡¨</h2>
  <div class="card">
    <form method="get" class="row-3" style="margin-bottom:10px">
      <div>
        <label>é—œéµå­—ï¼ˆå§“å/é›»è©±/LINE/åŸå› /ç¶“æ‰‹äººï¼‰</label>
        <input type="text" name="q" value="{{ q or '' }}" placeholder="è¼¸å…¥é—œéµå­—">
      </div>
      <div>
        <label>é¡å‹</label>
        <select name="type">
          <option value="">å…¨éƒ¨</option>
          <option value="white" {{ 'selected' if t=='white' else '' }}>ç™½åå–®</option>
          <option value="black" {{ 'selected' if t=='black' else '' }}>é»‘åå–®</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button type="submit">ç¯©é¸</button>
        <a class="btn-secondary" style="text-decoration:none;padding:9px 14px;border-radius:8px;color:#fff" href="{{ url_for('admin') }}">é‡ç½®</a>
      </div>
    </form>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å§“å</th>
            <th>é›»è©±</th>
            <th>LINE</th>
            <th>é¡å‹</th>
            <th>åŸå› </th>
            <th>ç¶“æ‰‹äºº</th>
            <th>å»ºç«‹</th>
            <th>æ›´æ–°</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for r in items %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.name }}</td>
            <td>{{ r.phone }}</td>
            <td>{{ r.line_id or '' }}</td>
            <td>
              <span class="pill {{ r.type }}">{{ 'ç™½åå–®' if r.type=='white' else 'é»‘åå–®' }}</span>
            </td>
            <td>{{ r.reason or '' }}</td>
            <td>{{ r.operator or '' }}</td>
            <td class="muted">{{ r.created_at }}</td>
            <td class="muted">{{ r.updated_at }}</td>
            <td class="actions">
              <a href="{{ url_for('edit_record', rid=r.id) }}" class="nav a" style="border:0;background:var(--brand);color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none">ç·¨è¼¯</a>
              <form method="post" action="{{ url_for('delete_record', rid=r.id) }}" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ');" style="display:inline">
                 <button class="btn-danger" type="submit">åˆªé™¤</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="10" class="muted">æ²’æœ‰è³‡æ–™</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="pagination">
      {% if page>1 %}
        <a href="{{ url_for('admin', q=q, type=t, page=page-1) }}" class="nav a" style="border:0;background:var(--brand);color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none">ä¸Šä¸€é </a>
      {% endif %}
      <span class="muted">ç¬¬ {{ page }} / {{ total_pages }} é ï¼ˆå…± {{ total }} ç­†ï¼‰</span>
      {% if page<total_pages %}
        <a href="{{ url_for('admin', q=q, type=t, page=page+1) }}" class="nav a" style="border:0;background:var(--brand);color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none">ä¸‹ä¸€é </a>
      {% endif %}
    </div>
  </div>
"""

FORM_BODY = r"""
  <h2>{{ 'æ–°å¢è³‡æ–™' if mode=='new' else 'ç·¨è¼¯è³‡æ–™' }}</h2>
  <div class="card">
    <form method="post">
      <div class="row">
        <div>
          <label>å§“å</label>
          <input type="text" name="name" value="{{ f.name or '' }}" required>
        </div>
        <div>
          <label>é›»è©±ï¼ˆæœƒæ­£è¦åŒ–ç‚º 09xxxxxxxxï¼‰</label>
          <input type="text" name="phone" value="{{ f.phone or '' }}" required>
        </div>
      </div>
      <div class="row">
        <div>
          <label>LINE IDï¼ˆå¯ç©ºï¼‰</label>
          <input type="text" name="line_id" value="{{ f.line_id or '' }}">
        </div>
        <div>
          <label>é¡å‹</label>
          <select name="type" required>
            <option value="white" {{ 'selected' if f.type=='white' else '' }}>ç™½åå–®</option>
            <option value="black" {{ 'selected' if f.type=='black' else '' }}>é»‘åå–®</option>
          </select>
        </div>
      </div>
      <div>
        <label>åŸå› ï¼ˆå¯ç©ºï¼‰</label>
        <textarea name="reason" rows="3" placeholder="å‚™è¨» / ç´€éŒ„">{{ f.reason or '' }}</textarea>
      </div>
      <div>
        <label>ç¶“æ‰‹äººï¼ˆå¯ç©ºï¼‰</label>
        <input type="text" name="operator" value="{{ f.operator or '' }}" placeholder="ä¾‹å¦‚ï¼šå°ç¾">
      </div>

      <div style="display:flex;gap:10px;margin-top:10px">
        <button type="submit">{{ 'æ–°å¢' if mode=='new' else 'å„²å­˜' }}</button>
        <a class="btn-secondary" style="text-decoration:none;padding:9px 14px;border-radius:8px;color:#fff" href="{{ url_for('admin') }}">å›åˆ—è¡¨</a>
      </div>
    </form>
  </div>
"""

def render_base(body_html, active="index", **kwargs):
    return render_template_string(
        BASE_HTML,
        title=APP_TITLE,
        brand="èŒ—æ®¿",
        active=active,
        now=datetime.now(),
        body=body_html,
        **kwargs
    )

# ---------- è·¯ç”±ï¼šå‰å°æŸ¥è©¢ ----------
@app.route("/", methods=["GET", "POST"])
def index():
    phone = ""
    search_result = []
    searched = False

    if request.method == "POST":
        phone = normalize_phone(request.form.get("phone", ""))
        searched = True
        if phone:
            conn = get_conn()
            c = conn.cursor()
            c.execute("SELECT * FROM records WHERE phone = ? ORDER BY updated_at DESC", (phone,))
            rows = c.fetchall()
            conn.close()

            for r in rows:
                search_result.append({
                    "type": r["type"],
                    "record": {
                        "name": r["name"],
                        "phone": r["phone"],
                        "line_id": r["line_id"],
                        "reason": r["reason"],
                        "created_at": r["created_at"],
                        "updated_at": r["updated_at"],
                    }
                })
        else:
            flash("è«‹è¼¸å…¥é›»è©±ï½")

    body = render_template_string(INDEX_BODY, phone=phone, search_result=search_result, searched=searched)
    return render_base(body, active="index")

# ---------- è·¯ç”±ï¼šå¾Œå°åˆ—è¡¨ ----------
@app.route("/admin")
def admin():
    q = request.args.get("q", "").strip()
    t = request.args.get("type", "").strip()
    page = max(int(request.args.get("page", 1) or 1), 1)
    page_size = 12
    offset = (page - 1) * page_size

    where = []
    params = []
    if t and validate_type(t):
        where.append("type = ?")
        params.append(t)
    if q:
        like = f"%{q}%"
        where.append("(name LIKE ? OR phone LIKE ? OR IFNULL(line_id,'') LIKE ? OR IFNULL(reason,'') LIKE ? OR IFNULL(operator,'') LIKE ?)")
        params += [like, like, like, like, like]

    where_sql = ("WHERE " + " AND ".join(where)) if where else ""
    count_sql = f"SELECT COUNT(*) FROM records {where_sql}"
    list_sql = f"""
        SELECT * FROM records
        {where_sql}
        ORDER BY updated_at DESC
        LIMIT ? OFFSET ?
    """

    conn = get_conn()
    c = conn.cursor()
    total = c.execute(count_sql, params).fetchone()[0]
    rows = c.execute(list_sql, params + [page_size, offset]).fetchall()
    conn.close()

    total_pages = max((total + page_size - 1) // page_size, 1)

    body = render_template_string(ADMIN_BODY, items=rows, q=q, t=t, page=page, total=total, total_pages=total_pages)
    return render_base(body, active="admin")

# ---------- è·¯ç”±ï¼šæ–°å¢ ----------
@app.route("/record/new", methods=["GET", "POST"])
def new_record():
    if request.method == "POST":
        name = (request.form.get("name") or "").strip()
        phone = normalize_phone(request.form.get("phone") or "")
        line_id = (request.form.get("line_id") or "").strip()
        type_ = (request.form.get("type") or "").strip()
        reason = (request.form.get("reason") or "").strip()
        operator = (request.form.get("operator") or "").strip()

        if not name or not phone:
            flash("å§“åèˆ‡é›»è©±ç‚ºå¿…å¡«ï½")
        elif not validate_type(type_):
            flash("é¡å‹å¿…é ˆæ˜¯ç™½åå–®æˆ–é»‘åå–®ï½")
        else:
            now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            conn = get_conn()
            c = conn.cursor()
            c.execute("""
                INSERT INTO records (name, phone, line_id, type, reason, operator, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """, (name, phone, line_id, type_, reason, operator, now, now))
            conn.commit()
            conn.close()
            flash("æ–°å¢æˆåŠŸâ™¡")
            return redirect(url_for("admin"))

    body = render_template_string(FORM_BODY, mode="new", f=request.form)
    return render_base(body, active="new")

# ---------- è·¯ç”±ï¼šç·¨è¼¯ ----------
@app.route("/record/<int:rid>/edit", methods=["GET", "POST"])
def edit_record(rid):
    conn = get_conn()
    c = conn.cursor()

    if request.method == "POST":
        name = (request.form.get("name") or "").strip()
        phone = normalize_phone(request.form.get("phone") or "")
        line_id = (request.form.get("line_id") or "").strip()
        type_ = (request.form.get("type") or "").strip()
        reason = (request.form.get("reason") or "").strip()
        operator = (request.form.get("operator") or "").strip()

        if not name or not phone:
            flash("å§“åèˆ‡é›»è©±ç‚ºå¿…å¡«ï½")
        elif not validate_type(type_):
            flash("é¡å‹å¿…é ˆæ˜¯ç™½åå–®æˆ–é»‘åå–®ï½")
        else:
            now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            c.execute("""
                UPDATE records SET name=?, phone=?, line_id=?, type=?, reason=?, operator=?, updated_at=?
                WHERE id=?
            """, (name, phone, line_id, type_, reason, operator, now, rid))
            conn.commit()
            conn.close()
            flash("å·²æ›´æ–°å®Œç•¢ï½")
            return redirect(url_for("admin"))

    row = c.execute("SELECT * FROM records WHERE id=?", (rid,)).fetchone()
    conn.close()
    if not row:
        flash("æ‰¾ä¸åˆ°é€™ç­†è³‡æ–™ï¼ï¼œ")
        return redirect(url_for("admin"))

    body = render_template_string(FORM_BODY, mode="edit", f=row)
    return render_base(body, active="admin")

# ---------- è·¯ç”±ï¼šåˆªé™¤ ----------
@app.route("/record/<int:rid>/delete", methods=["POST"])
def delete_record(rid):
    conn = get_conn()
    c = conn.cursor()
    c.execute("DELETE FROM records WHERE id=?", (rid,))
    conn.commit()
    conn.close()
    flash("å·²åˆªé™¤é€™ç­†è³‡æ–™ã€‚")
    return redirect(url_for("admin"))

# ---------- å•Ÿå‹• ----------
if __name__ == "__main__":
    init_db()
    # é å…ˆå¡ä¸€å…©ç­†ç¤ºç¯„è³‡æ–™ï¼ˆè‹¥è³‡æ–™è¡¨ç‚ºç©ºï¼‰
    conn = get_conn()
    cur = conn.cursor()
    count = cur.execute("SELECT COUNT(*) FROM records").fetchone()[0]
    if count == 0:
        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        demo = [
            ("å°ç™½", "0912345678", "white_user", "white", "ç†Ÿå®¢", "å°å¹«æ‰‹ç³–ç³–", now, now),
            ("å°é»‘", "0987654321", None, "black", "æ›¾ç¶“æ”¾é³¥", "å°å¹«æ‰‹ç³–ç³–", now, now),
        ]
        cur.executemany("""
            INSERT INTO records (name, phone, line_id, type, reason, operator, created_at, updated_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, demo)
        conn.commit()
    conn.close()

    app.run(debug=True)
