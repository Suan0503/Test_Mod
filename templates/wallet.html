<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å„²å€¼é‡‘å°ˆå€</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Zen Maru Gothic','å¾®è»Ÿæ­£é»‘é«”',sans-serif;background:#f9f7f5;margin:0;color:#444}
    .header{padding:20px;text-align:center;background:#e8eaf6;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .header a{display:inline-block;margin:6px 8px;background:#7e57c2;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:18px;margin-bottom:18px}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left;font-size:.9rem}
    thead tr{background:#ede7f6;color:#673ab7}
    .flash-wrapper{max-width:1100px;margin:10px auto 0;padding:0 16px}
    .flash{background:#fff;padding:10px 14px;margin-bottom:8px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);font-size:.85rem;border-left:6px solid #64b5f6}
    .flash-success{border-left-color:#81c784}
    .flash-danger{border-left-color:#e57373}
    .flash-warning{border-left-color:#ffb74d}
    .flash-info{border-left-color:#64b5f6}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #e0c7d4;border-radius:10px}
    button{background:#7e57c2;color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .danger{background:#e57373}
  </style>
  <script>
    function confirmConsume(){
      return confirm('ç¢ºèªæ‰£æ¬¾ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·');
    }
  </script>
</head>
<body>
  <div class="header">
    <h2>ğŸ’³ å„²å€¼é‡‘å°ˆå€</h2>
    <a href="/admin/home">å›å¾Œå°ä¸»é </a>
  </div>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-wrapper">
        {% for category,msg in messages %}
          <div class="flash flash-{{ category }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  <div class="container">
    <div class="card">
      <form method="get" action="/admin/wallet" style="display:flex;gap:10px;align-items:center">
        <input name="q" value="{{ q or '' }}" placeholder="è¼¸å…¥æ‰‹æ©Ÿæˆ–ç”¨æˆ¶ç·¨è™ŸæŸ¥è©¢" />
        <button type="submit">æŸ¥è©¢</button>
      </form>
  {% if error %}
  <div style="margin-top:10px;color:#d32f2f;font-size:.85rem;">{{ error }}</div>
  {% endif %}
  {% if not wallet and q %}
  <div style="margin-top:10px;color:#666;font-size:.85rem;">æœªæ‰¾åˆ°è³‡æ–™ï¼Œå¯ç¢ºèªæ˜¯å¦è¼¸å…¥æ­£ç¢ºæˆ–è©²æ‰‹æ©Ÿå°šæœªå»ºç«‹éŒ¢åŒ…ï¼ˆå¯ç›´æ¥å„²å€¼è‡ªå‹•å»ºç«‹ï¼‰ã€‚</div>
  {% elif not wallet and not q %}
  <div style="margin-top:10px;color:#666;font-size:.85rem;">è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿæˆ–ç™½åå–®ç·¨è™ŸæŸ¥è©¢ã€‚</div>
  {% endif %}
    </div>

    {% if wallet %}
    <div class="row">
      <div class="col">
        <div class="card">
          <h3>ç”¨æˆ¶è³‡è¨Š</h3>
          <div>æ‰‹æ©Ÿï¼š{{ wallet.phone or 'æœªç¶å®š' }}</div>
          <div>ç™½åå–®ç·¨è™Ÿï¼š{{ wallet.whitelist_id or 'æœªç¶å®š' }}</div>
          <div>ç›®å‰é¤˜é¡ï¼š<b>{{ wallet.balance }}</b></div>
          <div style="margin-top:6px;font-weight:600;">æœ‰æœŸé™æŠ˜åƒ¹åˆ¸ï¼š</div>
          {% if expiring_coupons %}
            <ul style="margin:4px 0 8px;padding-left:18px;font-size:.85rem;">
              {% for c in expiring_coupons %}
              <li>{{ c.amount }}å…ƒ x {{ c.count }} ({{ c.expiry }})</li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="font-size:.8rem;color:#666">ç„¡</div>
          {% endif %}
          <div style="margin-top:6px;font-weight:600;">æ¯æ—¥æŠ½çåˆ¸ï¼ˆåƒ…ç•¶æ—¥ï¼‰ï¼š</div>
          {% if today_draw_coupons %}
            <ul style="margin:4px 0 8px;padding-left:18px;font-size:.85rem;">
              {% for c in today_draw_coupons %}
              <li>{{ c.amount }}å…ƒ x {{ c.count }} (ä»Šæ—¥)</li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="font-size:.8rem;color:#666">å°šæœªä¸­çæˆ–å·²éæœŸ</div>
          {% endif %}
          <div style="margin-top:6px;font-weight:600;">ç„¡æœŸé™æŠ˜åƒ¹åˆ¸ï¼š</div>
          {% if permanent_coupons %}
            <ul style="margin:4px 0 8px;padding-left:18px;font-size:.85rem;">
              {% for c in permanent_coupons %}
              <li>{{ c.amount }}å…ƒ x {{ c.count }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="font-size:.8rem;color:#666">ç„¡</div>
          {% endif %}
          <div>ä¸Šæ¬¡åˆ°æœŸæé†’ï¼š{{ wallet.last_coupon_notice_at.strftime('%Y/%m/%d %H:%M:%S') if wallet.last_coupon_notice_at else 'å°šæœªæé†’' }}</div>
        </div>
        <div class="card">
          <h3>å„²å€¼</h3>
          <form method="post" action="/admin/wallet/topup">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="phone" value="{{ wallet.phone }}">
            <label>é‡‘é¡</label>
            <input name="amount" type="number" min="0" required />
            <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <button type="button" onclick="applyPreset('10k')">å¥—ç”¨ 10000 å…ƒæ–¹æ¡ˆ</button>
              <button type="button" onclick="applyPreset('5k')">å¥—ç”¨ 5000 å…ƒæ–¹æ¡ˆ</button>
              <span style="font-size:.8rem;color:#666">ï¼ˆä¾æ—¥æœŸè‡ªå‹•å¸¶å…¥ä¸åŒæŠ˜åƒ¹åˆ¸çµ„åˆï¼‰</span>
            </div>
            <label>å‚™è¨»</label>
            <textarea name="remark" rows="2" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šç¾é‡‘ã€è½‰å¸³å¾Œäº”ç¢¼...ï¼‰"></textarea>
            <div style="display:flex;gap:10px;margin-top:8px;align-items:flex-end;flex-wrap:wrap">
              <div>
                <label>500åˆ¸</label>
                <input name="coupon_500_count" type="number" min="0" value="0" style="width:80px" />
              </div>
              <div>
                <label>300åˆ¸</label>
                <input name="coupon_300_count" type="number" min="0" value="0" style="width:80px" />
              </div>
              <div>
                <label>100åˆ¸</label>
                <input name="coupon_100_count" type="number" min="0" value="0" style="width:80px" />
              </div>
              <div style="display:flex;flex-direction:column;gap:4px;">
                <label style="font-size:.75rem;color:#444">æ˜¯å¦æœ‰æœŸé™</label>
                <div style="font-size:.7rem;display:flex;gap:6px;align-items:center;">
                  <label><input type="radio" name="coupon_expiry_mode" value="expiring" checked /> æœ‰æœŸé™</label>
                  <label><input type="radio" name="coupon_expiry_mode" value="permanent" /> ç„¡æœŸé™</label>
                </div>
                <div style="margin-top:4px;">
                  <input name="coupon_expiry_date" type="date" value="2026-01-31" style="width:140px" />
                </div>
              </div>
            </div>
            <div style="margin-top:10px"><button type="submit">å„²å€¼</button></div>
          </form>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3>æ‰£æ¬¾</h3>
          <form method="post" action="/admin/wallet/consume" onsubmit="return confirmConsume()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="phone" value="{{ wallet.phone }}">
            <label>é‡‘é¡</label>
            <input name="amount" type="number" min="0" required />
            <label>å‚™è¨»</label>
            <textarea name="remark" rows="2" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šé ç´„ç´€éŒ„ï¼‰"></textarea>
            <div style="display:flex;gap:10px;margin-top:8px;align-items:flex-end;flex-wrap:wrap">
              <div>
                <label>500åˆ¸</label>
                <input name="coupon_500_count" type="number" min="0" value="0" />
              </div>
              <div>
                <label>300åˆ¸</label>
                <input name="coupon_300_count" type="number" min="0" value="0" />
              </div>
              <div>
                <label>100åˆ¸</label>
                <input name="coupon_100_count" type="number" min="0" value="0" />
              </div>
            </div>
            <div style="margin-top:10px"><button type="submit" class="danger">æ‰£æ¬¾</button></div>
          </form>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>æœ€è¿‘äº¤æ˜“</h3>
      <table>
        <thead><tr><th>æ™‚é–“ï¼ˆå°åŒ—ï¼‰</th><th>é¡å‹</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>500åˆ¸</th><th>300åˆ¸</th><th>100åˆ¸</th><th>æ“ä½œ</th></tr></thead>
        <tbody>
          {% for t in txns %}
          <tr>
            <td>{{ t.created_at.strftime('%Y/%m/%d %H:%M') if t.created_at else '' }}</td>
            <td>{{ t.type }}</td>
            <td>{{ t.amount }}</td>
            <td>{{ t.remark }}</td>
            <td>{{ t.coupon_500_count }}</td>
            <td>{{ t.coupon_300_count }}</td>
            <td>{{ t.coupon_100_count }}</td>
            <td>
              <form method="post" action="/admin/wallet/txn/delete" onsubmit="return confirm('ç¢ºèªåˆªé™¤æ­¤äº¤æ˜“ï¼Ÿ')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id" value="{{ t.id }}">
                <input type="hidden" name="phone" value="{{ wallet.phone }}">
                <button type="submit" class="danger">åˆªé™¤</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
  <script>
  function dateInRange(d, startMonth, startDay, endMonth, endDay){
    const y = d.getFullYear();
    const start = new Date(y, startMonth-1, startDay);
    const end = new Date(y, endMonth-1, endDay, 23,59,59,999);
    return d>=start && d<=end;
  }
  function applyPreset(kind){
    const now = new Date();
    const isFirst = dateInRange(now, 11, 14, 11, 21);
    const isSecond = dateInRange(now, 11, 22, 11, 30);
    const amt = (kind === '10k') ? 10000 : 5000;
    const form = document.querySelector('form[action="/admin/wallet/topup"]');
    if(!form) return;
    form.querySelector('input[name="amount"]').value = amt;
    let c500=0, c300=0, c100=0;
    if (isFirst){
      if (amt===10000){ c500=4; c300=6; }
      else { c500=1; c300=3; }
    } else if (isSecond){
      if (amt===10000){ c500=3; c300=5; }
      else { c500=0; c300=4; }
    }
    form.querySelector('input[name="coupon_500_count"]').value = c500;
    form.querySelector('input[name="coupon_300_count"]').value = c300;
    const c100Input = form.querySelector('input[name="coupon_100_count"]');
    if (c100Input) c100Input.value = c100;
  }
  </script>
</body>
</html>
