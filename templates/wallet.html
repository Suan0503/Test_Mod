<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å„²å€¼é‡‘å°ˆå€</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Zen Maru Gothic','å¾®è»Ÿæ­£é»‘é«”',sans-serif;background:#f9f7f5;margin:0;color:#444}
    .header{padding:20px;text-align:center;background:#e8eaf6;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .header a{display:inline-block;margin:6px 8px;background:#7e57c2;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:18px;margin-bottom:18px}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left;font-size:.9rem}
    thead tr{background:#ede7f6;color:#673ab7}
    .flash-wrapper{max-width:1100px;margin:10px auto 0;padding:0 16px}
    .flash{background:#fff;padding:10px 14px;margin-bottom:8px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);font-size:.85rem;border-left:6px solid #64b5f6}
    .flash-success{border-left-color:#81c784}
    .flash-danger{border-left-color:#e57373}
    .flash-warning{border-left-color:#ffb74d}
    .flash-info{border-left-color:#64b5f6}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #e0c7d4;border-radius:10px}
    button{background:#7e57c2;color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .danger{background:#e57373}
  </style>
  <script>
    function confirmConsume(){
      return confirm('ç¢ºèªæ‰£æ¬¾ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·');
    }
  </script>
</head>
<body>
  <div class="header">
    <h2>ğŸ’³ å„²å€¼é‡‘å°ˆå€</h2>
    <a href="/admin/home">å›å¾Œå°ä¸»é </a>
  </div>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-wrapper">
        {% for category,msg in messages %}
          <div class="flash flash-{{ category }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  <div class="container">
    <div class="card">
      <form method="get" action="/admin/wallet" style="display:flex;gap:10px;align-items:center">
        <input name="q" value="{{ q or '' }}" placeholder="è¼¸å…¥æ‰‹æ©Ÿæˆ–ç”¨æˆ¶ç·¨è™ŸæŸ¥è©¢" />
        <button type="submit">æŸ¥è©¢</button>
      </form>
  {% if error %}
  <div style="margin-top:10px;color:#d32f2f;font-size:.85rem;">{{ error }}</div>
  {% endif %}
  {% if not wallet and q %}
  <div style="margin-top:10px;color:#666;font-size:.85rem;">æœªæ‰¾åˆ°è³‡æ–™ï¼Œå¯ç¢ºèªæ˜¯å¦è¼¸å…¥æ­£ç¢ºæˆ–è©²æ‰‹æ©Ÿå°šæœªå»ºç«‹éŒ¢åŒ…ï¼ˆå¯ç›´æ¥å„²å€¼è‡ªå‹•å»ºç«‹ï¼‰ã€‚</div>
  {% elif not wallet and not q %}
  <div style="margin-top:10px;color:#666;font-size:.85rem;">è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿæˆ–ç™½åå–®ç·¨è™ŸæŸ¥è©¢ã€‚</div>
  {% endif %}
    </div>

    {% if wallet %}
    <div class="row">
      <div class="col">
        <div class="card">
          <h3>ç”¨æˆ¶è³‡è¨Š</h3>
          <div>æ‰‹æ©Ÿï¼š{{ wallet.phone or 'æœªç¶å®š' }}</div>
          <div>ç™½åå–®ç·¨è™Ÿï¼š{{ wallet.whitelist_id or 'æœªç¶å®š' }}</div>
          <div>ç›®å‰é¤˜é¡ï¼š<b>{{ wallet.balance }}</b></div>
          {% set txs = txns %}
          {% set c500 = 0 %}
          {% set c300 = 0 %}
          {% for t in txs %}
            {% set sign = 1 if t.type == 'topup' else -1 %}
            {% set c500 = c500 + (sign * (t.coupon_500_count or 0)) %}
            {% set c300 = c300 + (sign * (t.coupon_300_count or 0)) %}
          {% endfor %}
          <div>æŠ˜åƒ¹åˆ¸å‰©é¤˜ï¼š500åˆ¸ x {{ c500 if c500>0 else 0 }}ã€300åˆ¸ x {{ c300 if c300>0 else 0 }}</div>
          <div>ä¸Šæ¬¡åˆ°æœŸæé†’ï¼š{{ wallet.last_coupon_notice_at.strftime('%Y/%m/%d %H:%M:%S') if wallet.last_coupon_notice_at else 'å°šæœªæé†’' }}</div>
        </div>
        <div class="card">
          <h3>å„²å€¼</h3>
          <form method="post" action="/admin/wallet/topup">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="phone" value="{{ wallet.phone }}">
            <label>é‡‘é¡</label>
            <input name="amount" type="number" min="1" required />
            <label>å‚™è¨»</label>
            <textarea name="remark" rows="2" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šç¾é‡‘ã€è½‰å¸³å¾Œäº”ç¢¼...ï¼‰"></textarea>
            <div style="display:flex;gap:10px;margin-top:8px">
              <div>
                <label>500åˆ¸</label>
                <input name="coupon_500_count" type="number" min="0" value="0" />
              </div>
              <div>
                <label>300åˆ¸</label>
                <input name="coupon_300_count" type="number" min="0" value="0" />
              </div>
            </div>
            <div style="margin-top:10px"><button type="submit">å„²å€¼</button></div>
          </form>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3>æ‰£æ¬¾</h3>
          <form method="post" action="/admin/wallet/consume" onsubmit="return confirmConsume()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="phone" value="{{ wallet.phone }}">
            <label>é‡‘é¡</label>
            <input name="amount" type="number" min="1" required />
            <label>å‚™è¨»</label>
            <textarea name="remark" rows="2" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šé ç´„ç´€éŒ„ï¼‰"></textarea>
            <div style="display:flex;gap:10px;margin-top:8px">
              <div>
                <label>500åˆ¸</label>
                <input name="coupon_500_count" type="number" min="0" value="0" />
              </div>
              <div>
                <label>300åˆ¸</label>
                <input name="coupon_300_count" type="number" min="0" value="0" />
              </div>
            </div>
            <div style="margin-top:10px"><button type="submit" class="danger">æ‰£æ¬¾</button></div>
          </form>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>æœ€è¿‘äº¤æ˜“</h3>
      <table>
        <thead><tr><th>æ™‚é–“</th><th>é¡å‹</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>500åˆ¸</th><th>300åˆ¸</th></tr></thead>
        <tbody>
          {% for t in txns %}
          <tr>
            <td>{{ t.created_at.strftime('%Y/%m/%d %H:%M') if t.created_at else '' }}</td>
            <td>{{ t.type }}</td>
            <td>{{ t.amount }}</td>
            <td>{{ t.remark }}</td>
            <td>{{ t.coupon_500_count }}</td>
            <td>{{ t.coupon_300_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
</body>
</html>
