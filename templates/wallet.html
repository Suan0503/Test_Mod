<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å„²å€¼é‡‘å°ˆå€</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Zen Maru Gothic','å¾®è»Ÿæ­£é»‘é«”',sans-serif;background:#f9f7f5;margin:0;color:#444}
    .header{padding:20px;text-align:center;background:#e8eaf6;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .header a{display:inline-block;margin:6px 8px;background:#7e57c2;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:18px;margin-bottom:18px}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left;font-size:.9rem}
    thead tr{background:#ede7f6;color:#673ab7}
    .flash-wrapper{max-width:1100px;margin:10px auto 0;padding:0 16px}
    .flash{background:#fff;padding:10px 14px;margin-bottom:8px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);font-size:.85rem;border-left:6px solid #64b5f6}
    .flash-success{border-left-color:#81c784}
    .flash-danger{border-left-color:#e57373}
    .flash-warning{border-left-color:#ffb74d}
    .flash-info{border-left-color:#64b5f6}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #e0c7d4;border-radius:10px}
    button{background:#7e57c2;color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}
    .danger{background:#e57373}
  </style>
  <script>
    function confirmConsume(){
      return confirm('ç¢ºèªæ‰£æ¬¾ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·');
    }
  </script>
</head>
<body>
  <div class="header">
    <h2>ğŸ’³ å„²å€¼é‡‘å°ˆå€</h2>
  <a href="/admin/home">å›å¾Œå°ä¸»é </a>
  <a href="/admin/wallet/reconcile">å„²å€¼å°å¸³</a>
  <a href="/admin/wallet/reconcile/consume">æ‰£æ¬¾å°å¸³</a>
  <a href="/admin/wallet/summary">å„²å€¼è¨˜éŒ„</a>
  </div>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-wrapper">
        {% for category, msg in messages %}
        <div class="flash flash-{{ category }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="container">
    <div class="card">
      <form method="get" action="/admin/wallet" style="display:flex;gap:10px;align-items:center">
        <input name="q" value="{{ q or '' }}" placeholder="è¼¸å…¥æ‰‹æ©Ÿæˆ–ç”¨æˆ¶ç·¨è™ŸæŸ¥è©¢" />
        <button type="submit">æŸ¥è©¢</button>
      </form>
      {% if error %}
      <div style="margin-top:10px;color:#d32f2f;font-size:.85rem;">{{ error }}</div>
      {% endif %}
      {% if not wallet and q %}
      <div style="margin-top:10px;color:#666;font-size:.85rem;">æœªæ‰¾åˆ°è³‡æ–™ï¼Œå¯ç¢ºèªæ˜¯å¦è¼¸å…¥æ­£ç¢ºæˆ–è©²æ‰‹æ©Ÿå°šæœªå»ºç«‹éŒ¢åŒ…ï¼ˆå¯ç›´æ¥å„²å€¼è‡ªå‹•å»ºç«‹ï¼‰ã€‚</div>
      {% elif not wallet and not q %}
      <div style="margin-top:10px;color:#666;font-size:.85rem;">è«‹å…ˆè¼¸å…¥æ‰‹æ©Ÿæˆ–ç™½åå–®ç·¨è™ŸæŸ¥è©¢ã€‚</div>
      {% endif %}
    </div>

    {% if wallet %}
      <div style="margin-bottom:18px;display:flex;gap:8px;flex-wrap:wrap">
      </div>
    <div class="row">
      <div class="col">
        <div class="card">
          <h3>ç”¨æˆ¶è³‡è¨Š</h3>
          <div>æ‰‹æ©Ÿï¼š{{ wallet.phone or 'æœªç¶å®š' }}</div>
          <div>ç™½åå–®ç·¨è™Ÿï¼š{{ wallet.whitelist_id or 'æœªç¶å®š' }}</div>
          <div>ç”¨æˆ¶æš±ç¨±ï¼š{{ (wl_user.name if wl_user and wl_user.name else 'â€”') }}</div>
          <div>LINE IDï¼š{{ (wl_user.line_id if wl_user and wl_user.line_id else 'æœªç™»è¨˜') }}</div>
          <div>ç›®å‰é¤˜é¡ï¼š<b>{{ wallet.balance }}</b></div>
          <div>æŠ˜åƒ¹åˆ¸å‰©é¤˜ï¼š500åˆ¸ x {{ coupon_500_total or 0 }}ã€300åˆ¸ x {{ coupon_300_total or 0 }}ã€100åˆ¸ x {{ coupon_100_total or 0 }}</div>
          <div>ä¸Šæ¬¡åˆ°æœŸæé†’ï¼š{{ wallet.last_coupon_notice_at.strftime('%Y/%m/%d %H:%M:%S') if wallet.last_coupon_notice_at else 'å°šæœªæé†’' }}</div>
        </div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <h3 style="margin:0">å„²å€¼</h3>
            <div style="display:flex;gap:8px">
              <button type="button" onclick="applyPreset(10000)">10000 å…ƒæ–¹æ¡ˆ</button>
              <button type="button" onclick="applyPreset(5000)">5000 å…ƒæ–¹æ¡ˆ</button>
            </div>
          </div>
          <form id="topup-form" method="post" action="/admin/wallet/topup">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="phone" value="{{ wallet.phone }}">
            <label>é‡‘é¡</label>
            <input name="amount" type="number" min="0" required />
            <div style="display:flex;gap:10px;align-items:center;margin:6px 0 2px">
              <div>
                <label>ä»˜æ¬¾æ–¹å¼</label>
                <select name="payment_method" style="min-width:120px">
                  <option value="">æœªé¸</option>
                  <option value="CASH">ç¾é‡‘</option>
                  <option value="BANK">åŒ¯æ¬¾</option>
                  <option value="CARD">åˆ·å¡</option>
                  <option value="TWQR">å°ç£Pay/æƒç¢¼</option>
                  <option value="OTHER">å…¶ä»–</option>
                </select>
              </div>
              <div>
                <label>å–®è™Ÿ/å¾Œäº”ç¢¼</label>
                <input type="text" name="reference_id" placeholder="äº¤æ˜“åºè™Ÿæˆ–å¾Œäº”ç¢¼" style="min-width:160px" />
              </div>
              <div>
                <label>ç¶“æ‰‹äºº</label>
                <input type="text" name="operator" placeholder="ç¶“æ‰‹äºº" style="min-width:120px" />
              </div>
            </div>
            <label>å‚™è¨»</label>
            <textarea name="remark" rows="2" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šç¾é‡‘ã€è½‰å¸³å¾Œäº”ç¢¼...ï¼‰"></textarea>
            <div style="display:flex;gap:10px;margin-top:8px;align-items:flex-end">
              <div>
                <label>500åˆ¸</label>
                <input name="coupon_500_count" type="number" min="0" value="0" style="max-width:90px" />
              </div>
              <div>
                <label>300åˆ¸</label>
                <input name="coupon_300_count" type="number" min="0" value="0" style="max-width:90px" />
              </div>
              <div>
                <label>100åˆ¸</label>
                <input name="coupon_100_count" type="number" min="0" value="0" style="max-width:90px" />
              </div>
            </div>
            <div style="margin-top:10px"><button type="submit">å„²å€¼</button></div>
          </form>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3>æ‰£æ¬¾</h3>
          <form method="post" action="/admin/wallet/consume" onsubmit="return confirmConsume()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="phone" value="{{ wallet.phone }}">
            <label>é‡‘é¡</label>
            <input name="amount" type="number" min="0" required />
            <label>å‚™è¨»</label>
            <textarea name="remark" rows="2" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šé ç´„ç´€éŒ„ï¼‰"></textarea>
            <div style="display:flex;gap:10px;margin-top:8px">
              <div>
                <label>500åˆ¸</label>
                <input name="coupon_500_count" type="number" min="0" value="0" style="max-width:90px" />
              </div>
              <div>
                <label>300åˆ¸</label>
                <input name="coupon_300_count" type="number" min="0" value="0" style="max-width:90px" />
              </div>
              <div>
                <label>100åˆ¸</label>
                <input name="coupon_100_count" type="number" min="0" value="0" style="max-width:90px" />
              </div>
            </div>
            <div style="margin-top:10px"><button type="submit" class="danger">æ‰£æ¬¾</button></div>
          </form>
        </div>
        <div class="card">
          <h3>æ‰‹å‹•æ²–æ­£ / èª¿æ•´</h3>
          <form method="post" action="/admin/wallet/adjust" onsubmit="return confirm('ç¢ºèªåŸ·è¡Œæ‰‹å‹•èª¿æ•´ï¼Ÿ')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="phone" value="{{ wallet.phone }}">
            <label>é‡‘é¡ï¼ˆå¯æ­£å¯è² ï¼‰</label>
            <input name="amount" type="number" step="1" required />
            <div style="display:flex;gap:10px;align-items:center;margin:6px 0 2px">
              <div>
                <label>ç¶“æ‰‹äºº</label>
                <input type="text" name="operator" placeholder="ç¶“æ‰‹äºº" style="min-width:120px" />
              </div>
            </div>
            <label>å‚™è¨»</label>
            <textarea name="remark" rows="2" placeholder="è«‹å¡«å¯«èª¿æ•´åŸå› "></textarea>
            <div style="margin-top:10px"><button type="submit">åŸ·è¡Œèª¿æ•´</button></div>
          </form>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>æœ€è¿‘äº¤æ˜“</h3>
      <table>
  <thead><tr><th>æ™‚é–“</th><th>é¡å‹</th><th>é‡‘é¡</th><th>ä»˜æ¬¾æ–¹å¼</th><th>å–®è™Ÿ</th><th>ç¶“æ‰‹äºº</th><th>å‚™è¨»</th><th>500åˆ¸</th><th>300åˆ¸</th><th>100åˆ¸</th><th>æ“ä½œ</th></tr></thead>
        <tbody>
          {% for t in txns %}
          <tr>
            <td>{{ t.local_time_str }}</td>
            <td>{{ t.type }}</td>
            <td>{{ t.amount }}</td>
      <td>{{ t.payment_method or 'â€”' }}</td>
  <td>{{ t.reference_id or 'â€”' }}</td>
  <td>{{ t.operator or 'â€”' }}</td>
            <td>{{ t.adjusted_remark or t.remark }}</td>
            <td>{{ t.coupon_500_count }}</td>
            <td>{{ t.coupon_300_count }}</td>
            <td>{{ t.coupon_100_count if t.coupon_100_count is not none else 0 }}</td>
            <td>
              <form method="post" action="/admin/wallet/txn/delete" onsubmit="return confirm('ç¢ºèªåˆªé™¤æ­¤äº¤æ˜“ï¼Ÿ')" style="display:inline-block">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id" value="{{ t.id }}">
                <input type="hidden" name="q" value="{{ wallet.phone }}">
                <button type="submit" class="danger" style="padding:6px 10px">åˆªé™¤</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
  <script>
    // ä¾ç…§æ—¥æœŸå€é–“è‡ªå‹•å¸¶å…¥ 10000/5000 é è¨­æ–¹æ¡ˆï¼ˆåªä½œç”¨æ–¼ä¸Šæ–¹å„²å€¼è¡¨å–®ï¼‰
    function applyPreset(total){
      const form = document.getElementById('topup-form');
      if(!form) return;
      const amountEl = form.querySelector('input[name="amount"]');
      const c500El = form.querySelector('input[name="coupon_500_count"]');
      const c300El = form.querySelector('input[name="coupon_300_count"]');
      const c100El = form.querySelector('input[name="coupon_100_count"]');
      if(amountEl) amountEl.value = total;
      let v500 = 0, v300 = 0;
      const now = new Date();
      const m = now.getMonth() + 1; // 1-12
      const d = now.getDate();
      const inA = (m === 11 && d >= 14 && d <= 21);
      const inB = (m === 11 && d >= 22 && d <= 30);
      if(inA){
        if(total === 10000){ v500 = 4; v300 = 6; }
        else if(total === 5000){ v500 = 1; v300 = 3; }
      } else if(inB){
        if(total === 10000){ v500 = 3; v300 = 5; }
        else if(total === 5000){ v500 = 0; v300 = 4; }
      } else {
        v500 = 0; v300 = 0;
      }
      if(c500El) c500El.value = v500;
      if(c300El) c300El.value = v300;
      if(c100El) c100El.value = 0; // 100åˆ¸ä¸è‡ªå‹•çµ¦
    }
  </script>
</body>
</html>
