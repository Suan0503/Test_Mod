{% extends 'admin_custom_master.html' %}
{% block body %}
<style>
  .schedule-table { border-collapse: collapse; width:100%; }
  .schedule-table th, .schedule-table td { border:1px solid #b6d6ff; padding:8px; text-align:center; }
  .schedule-table th { background:#e3f2fd; }
  .girl-name, .room-input { width:80px; display:block; margin:2px auto; }
  .lang-check { margin:0 4px; }
  .time-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .time-select, .duration-select { width: 90px; }
  .remove-time-btn { background: #f04747; color: #fff; border: none; border-radius: 6px; padding: 2px 8px; cursor: pointer; }
  .add-time-btn, .sort-time-btn { margin: 8px 4px; padding: 4px 12px; border-radius: 6px; border: none; background: #4f8cff; color: #fff; cursor: pointer; }
</style>
<div style="display:flex;">
  <!-- å·¦åŠé‚Šè¡¨å–® -->
  <div style="width:40%;padding:2em;">
    <form action="/schedule" method="post" style="background:rgba(44,34,68,0.85);border-radius:12px;padding:1.5em;box-shadow:0 4px 24px #1a2337;">
      <h4 style="color:#ffe082;">æ–°å¢æ’ç­</h4>
      <label for="new_girl">æ–°å¢å¦¹å¦¹ï¼š</label>
      <input type="text" name="new_girl" id="new_girl" placeholder="è«‹è¼¸å…¥å¦¹å¦¹åç¨±">
      <br><br>
      <label for="time">æ™‚é–“ï¼š</label>
      <select name="time" id="time" required>
        {% for h in range(0,24) %}
        <option value="{{ '%02d' % h }}:00">{{ '%02d' % h }}:00</option>
        <option value="{{ '%02d' % h }}:30">{{ '%02d' % h }}:30</option>
        {% endfor %}
      </select>
      <br><br>
      <label for="girl">é¸æ“‡å¦¹å¦¹ï¼š</label>
      <select name="girl" id="girl" required>
        {% for name in girls %}
        <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
      </select>
      <br><br>
      <label for="amount">é‡‘é¡ï¼š</label>
      <input type="number" name="amount" id="amount" required>
      <br><br>
      <label for="plan">æ–¹æ¡ˆï¼š</label>
      <select name="plan" id="plan" required>
        <option value="40">40</option>
        <option value="60">60</option>
        <option value="90">90</option>
      </select>
      <br><br>
      <button type="submit" style="background:#4f8cff;color:#fff;padding:8px 24px;border:none;border-radius:6px;">é€å‡º</button>
    </form>
      ï¼š
      <select name="minute" id="minute" required>
        <option value="00">00</option>
        <option value="30">30</option>
      </select>
      <br><br>
      <label for="plan">æ–¹æ¡ˆï¼š</label>
      <select name="plan" id="plan" required>
        <option value="40">40</option>
        <option value="60">60</option>
        <option value="90">90</option>
      </select>
      <br><br>
      <button type="submit" class="btn magic-effect">æ–°å¢ç­è¡¨</button>
    </form>
  </div>
  <!-- å³åŠé‚Šç­è¡¨ -->
  <div style="width:60%;padding:2em;">
    <table style="width:100%;background:rgba(44,34,68,0.85);border-radius:12px;color:#ffe082;">
      <tr>
        <th>å¦¹å¦¹</th>
        <th>æ™‚æ®µ</th>
        <th>æ–¹æ¡ˆ</th>
      </tr>
      {% for row in schedule %}
      <tr>
        <td>{{ row['å¦¹å¦¹'] }}</td>
        <td>{{ row['æ™‚æ®µ'] }}</td>
        <td>{{ row['æ–¹æ¡ˆ'] }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>
        </tr>
      </thead>
      <tbody id="girl-rows">
        {% for girl in ['å¤šå¤š', 'èè'] %}
        <tr>
          <td>
            <input type="text" class="girl-name" value="{{ girl }}" placeholder="åç¨±">
            <input type="text" class="room-input" placeholder="æˆ¿è™Ÿ">
          </td>
          <td>
            <label><input type="checkbox" class="lang-check" value="zh">ä¸­</label>
            <label><input type="checkbox" class="lang-check" value="en">è‹±</label>
          </td>
          <td>
            <select class="nation-select" style="width:90px;">
              <option value="tw">ğŸ‡¹ğŸ‡¼ å°ç£</option>
              <option value="vn">ğŸ‡»ğŸ‡³ è¶Šå—</option>
              <option value="th">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
              <option value="id">ğŸ‡®ğŸ‡© å°å°¼</option>
            </select>
          </td>
          <td>
            <div class="times-list"></div>
            <button class="add-time-btn" onclick="addTimeRow(this)">æ–°å¢æ™‚æ®µ</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="add-girl-btn" onclick="addGirlRow()" style="margin-top:12px;">æ–°å¢å¦¹å¦¹</button>
  </div>

  <div style="flex:1;">
    <h3>å³æ™‚æ’ç­çµæœ</h3>
    <div id="output-area" style="background:#f7f9fe;border-radius:8px;min-height:400px;padding:16px;font-size:16px;white-space:pre-line;"></div>
  </div>
</div>

<script>
const timeOptions = [
  '11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','00:00','01:00'
];
const durationOptions = ['40','60','90'];

function addTimeRow(btn) {
  const timesList = btn.parentNode.querySelector('.times-list');
  const div = document.createElement('div');
  div.className = 'time-row';
  div.innerHTML = `
    <select class="time-select">
      ${timeOptions.map(t=>`<option value="${t}">${t}</option>`).join('')}
    </select>
    <select class="duration-select">
      <option value="">--</option>
      ${durationOptions.map(d=>`<option value="${d}">${d}</option>`).join('')}
    </select>
    <button class="remove-time-btn" onclick="removeTimeRow(this)">åˆªé™¤</button>
  `;
  timesList.appendChild(div);
  getScheduleResult();
}
function removeTimeRow(btn) {
  btn.parentNode.remove();
  getScheduleResult();
}
function addGirlRow() {
  const tbody = document.getElementById('girl-rows');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <input type="text" class="girl-name" placeholder="åç¨±">
      <input type="text" class="room-input" placeholder="æˆ¿è™Ÿ">
    </td>
    <td>
      <label><input type="checkbox" class="lang-check" value="zh">ä¸­</label>
      <label><input type="checkbox" class="lang-check" value="en">è‹±</label>
    </td>
    <td>
      <select class="nation-select" style="width:90px;">
        <option value="tw">ğŸ‡¹ğŸ‡¼ å°ç£</option>
        <option value="vn">ğŸ‡»ğŸ‡³ è¶Šå—</option>
        <option value="th">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
        <option value="id">ğŸ‡®ğŸ‡© å°å°¼</option>
      </select>
    </td>
    <td>
      <div class="times-list"></div>
      <button class="add-time-btn" onclick="addTimeRow(this)">æ–°å¢æ™‚æ®µ</button>
    </td>
  `;
  tbody.appendChild(tr);
  getScheduleResult();
}
function sortAllTimes() {
  const tbody = document.getElementById('girl-rows');
  for(const tr of tbody.children) {
    const timesList = tr.querySelector('.times-list');
    if(!timesList) continue;
    const rows = Array.from(timesList.children);
    rows.sort((a,b)=>{
      const ta = a.querySelector('.time-select').value;
      const tb = b.querySelector('.time-select').value;
      return timeOptions.indexOf(ta) - timeOptions.indexOf(tb);
    });
    rows.forEach(r=>timesList.appendChild(r));
  }
  getScheduleResult();
}
function getNationInfo(nation, langs) {
  let emoji = '', lang = '';
  if (nation === 'tw') emoji = 'ğŸ‡¹ğŸ‡¼';
  if (nation === 'vn') emoji = 'ğŸ‡»ğŸ‡³';
  if (nation === 'th') emoji = 'ğŸ‡¹ğŸ‡­';
  if (nation === 'id') emoji = 'ğŸ‡®ğŸ‡©';

  if (langs.includes('zh') && nation === 'vn') lang = 'ä¸­è¶Šæ–‡æºé€š';
  else if (langs.includes('zh') && nation === 'th') lang = 'ä¸­æ³°æ–‡æºé€š';
  else if (langs.includes('zh') && nation === 'tw') lang = 'ä¸­æ–‡æºé€š';
  else if (langs.includes('en') && nation === 'vn') lang = 'è‹±è¶Šæ–‡æºé€š';
  else if (langs.includes('en') && nation === 'th') lang = 'è‹±æ³°æ–‡æºé€š';
  else if (nation === 'vn') lang = 'è¶Šæ–‡æºé€š';
  else if (nation === 'th') lang = 'æ³°æ–‡æºé€š';
  else if (nation === 'id') lang = 'å°å°¼æ–‡æºé€š';
  else lang = '';
  return { emoji, lang };
}
function getScheduleResult() {
  const tbody = document.getElementById('girl-rows');
  let result = '';
  for (const tr of tbody.children) {
    const name = tr.querySelector('.girl-name').value.trim();
    const room = tr.querySelector('.room-input').value.trim();
    const langChecks = tr.querySelectorAll('.lang-check');
    const langs = Array.from(langChecks).filter(c => c.checked).map(c => c.value);
    const nation = tr.querySelector('.nation-select').value;
    const nationInfo = getNationInfo(nation, langs);
    if (!name) continue;
    let line = `ğŸ’—${name} ${nationInfo.emoji} ${nationInfo.lang}${room ? ' ('+room+')' : ''}`;
    let slots = [];
    const timesList = tr.querySelector('.times-list');
    if(timesList) {
      for(const timeRow of timesList.children) {
        const time = timeRow.querySelector('.time-select').value;
        const dur = timeRow.querySelector('.duration-select').value;
        if(time && dur) {
          slots.push(`${time}/${dur}`);
        }
      }
    }
    if (slots.length) {
      line += '\n' + slots.join('\n');
      result += line + '\n\n';
    }
  }
  document.getElementById('output-area').innerText = result.trim();
}
document.getElementById('schedule-table').addEventListener('input', getScheduleResult);
document.getElementById('schedule-table').addEventListener('change', getScheduleResult);
</script>
{% endblock %}