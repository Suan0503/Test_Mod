{% extends 'admin_custom_master.html' %}
{% block body %}
<style>
  .schedule-wrap{ padding:24px 0; }
  .table-shell{ overflow:auto; border-radius:10px; background:#f7faff; padding:8px; }
  .schedule-table{ border-collapse:separate; border-spacing:0; width:100%; min-width:980px; table-layout:fixed; }
  .schedule-table th, .schedule-table td{ border:1px solid #b6d6ff; background:#fff; padding:10px; vertical-align:top; }
  .schedule-table thead th{ background:#eaf3ff; text-align:center; font-weight:600; }
  .col-girl{ width:280px; }
  .col-lang{ width:160px; }
  .col-nation{ width:160px; }
  .col-time{ min-width:480px; }

  /* å¦¹å¦¹æ¬„ä½ */
  .girl-box{ display:grid; grid-template-columns: 1fr 120px; gap:8px; align-items:center; }
  .girl-box input[type="text"]{ width:100%; }
  .room-input{ width:100%; }

  /* èªè¨€ */
  .lang-group{ display:flex; gap:12px; align-items:center; }
  .lang-group label{ display:inline-flex; align-items:center; gap:6px; }

  /* æ™‚æ®µç·¨è¼¯ */
  .slots{ display:flex; flex-direction:column; gap:8px; }
  .slot{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .slot select{ width:110px; }
  .slot .remove{ border:none; background:#ffe5e5; color:#c0392b; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .add-slot{ border:none; background:#e7f3ff; color:#1a73e8; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .add-girl-btn{ margin-top:12px; }

  /* å³å´è¼¸å‡º */
  #output-area{ background:#f7f9fe; border-radius:8px; min-height:420px; padding:16px; font-size:15px; white-space:pre-line; }
</style>

<div class="schedule-main" style="display:flex; gap:32px;" >
  <div style="flex:1; min-width:420px;">
    <h3>æ’ç­è¡¨</h3>

    <div class="table-shell">
      <table class="schedule-table" id="schedule-table">
        <thead>
          <tr>
            <th class="col-girl">å¦¹å¦¹ï¼ˆåç¨±ï¼æˆ¿é–“è™Ÿç¢¼ï¼‰</th>
            <th class="col-lang">èªè¨€</th>
            <th class="col-nation">åœ‹ç±</th>
            <th class="col-time">æ™‚é–“</th>
          </tr>
        </thead>
        <tbody id="girl-rows">
          <!-- å¤šå¤š -->
          <tr>
            <td class="col-girl">
              <div class="girl-box">
                <input type="text" class="girl-name" value="å¤šå¤š" placeholder="åç¨±">
                <input type="text" class="room-input" value="501007" placeholder="æˆ¿è™Ÿ">
              </div>
            </td>
            <td class="col-lang">
              <div class="lang-group">
                <label><input type="checkbox" class="lang-check" value="zh">ä¸­</label>
                <label><input type="checkbox" class="lang-check" value="en">è‹±</label>
              </div>
            </td>
            <td class="col-nation">
              <select class="nation-select" style="width:100%;">
                <option value="tw">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                <option value="vn">ğŸ‡»ğŸ‡³ è¶Šå—</option>
                <option value="th">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
                <option value="id">ğŸ‡®ğŸ‡© å°å°¼</option>
              </select>
            </td>
            <td class="col-time">
              <div class="slots">
                <!-- åˆå§‹çµ¦ä¸€å€‹æ™‚æ®µ -->
                <div class="slot">
                  <select class="start">
                    <!-- 11:00 ï½ 01:30ï¼ˆåŠå°æ™‚ä¸€æ ¼ï¼‰ -->
                    {% set starts = [
                      '11:00','11:30','12:00','12:30',
                      '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30','05:00','05:30',
                      '06:00','06:30','07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30',
                      '11:00','11:30','12:00','12:30','01:00'
                    ] %}
                    {% for s in starts %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                  </select>
                  <select class="duration">
                    <option value="">æ–¹æ¡ˆ</option>
                    <option value="40">40</option>
                    <option value="60" selected>60</option>
                    <option value="90">90</option>
                  </select>
                  <button type="button" class="remove" onclick="removeSlot(this)">åˆªé™¤</button>
                </div>
                <button type="button" class="add-slot" onclick="addSlot(this)">ï¼‹ æ–°å¢æ™‚æ®µ</button>
              </div>
            </td>
          </tr>

          <!-- èè -->
          <tr>
            <td class="col-girl">
              <div class="girl-box">
                <input type="text" class="girl-name" value="èè" placeholder="åç¨±">
                <input type="text" class="room-input" value="" placeholder="æˆ¿è™Ÿ">
              </div>
            </td>
            <td class="col-lang">
              <div class="lang-group">
                <label><input type="checkbox" class="lang-check" value="zh">ä¸­</label>
                <label><input type="checkbox" class="lang-check" value="en">è‹±</label>
              </div>
            </td>
            <td class="col-nation">
              <select class="nation-select" style="width:100%;">
                <option value="tw">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                <option value="vn">ğŸ‡»ğŸ‡³ è¶Šå—</option>
                <option value="th">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
                <option value="id">ğŸ‡®ğŸ‡© å°å°¼</option>
              </select>
            </td>
            <td class="col-time">
              <div class="slots">
                <button type="button" class="add-slot" onclick="addSlot(this)">ï¼‹ æ–°å¢æ™‚æ®µ</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <button class="add-girl-btn" onclick="addGirlRow()">æ–°å¢å¦¹å¦¹</button>
  </div>

  <div style="flex:1; min-width:320px;">
    <h3>å³æ™‚æ’ç­çµæœ</h3>
    <div id="output-area"></div>
  </div>
</div>

<script>
  // å¯é¸é–‹å§‹æ™‚é–“ï¼ˆåŠå°æ™‚ä¸€æ ¼ï¼‰
  const STARTS = [
    '11:00','11:30','12:00','12:30',
    '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30','05:00','05:30',
    '06:00','06:30','07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30',
    '11:00','11:30','12:00','12:30','01:00'
  ];

  function slotTemplate(){
    const startOptions = STARTS.map(s => `<option value="${s}">${s}</option>`).join('');
    return `
      <div class="slot">
        <select class="start">${startOptions}</select>
        <select class="duration">
          <option value="">æ–¹æ¡ˆ</option>
          <option value="40">40</option>
          <option value="60">60</option>
          <option value="90">90</option>
        </select>
        <button type="button" class="remove" onclick="removeSlot(this)">åˆªé™¤</button>
      </div>`;
  }

  function addSlot(btn){
    const slotsBox = btn.closest('.slots');
    // æŒ‰éˆ•æ°¸é æ”¾åœ¨æœ€å¾Œï¼Œæ’åœ¨æŒ‰éˆ•å‰é¢
    btn.insertAdjacentHTML('beforebegin', slotTemplate());
    updateOutput();
  }

  function removeSlot(el){
    const slot = el.closest('.slot');
    slot.remove();
    updateOutput();
  }

  function addGirlRow(){
    const tbody = document.getElementById('girl-rows');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-girl">
        <div class="girl-box">
          <input type="text" class="girl-name" value="" placeholder="åç¨±">
          <input type="text" class="room-input" value="" placeholder="æˆ¿è™Ÿ">
        </div>
      </td>
      <td class="col-lang">
        <div class="lang-group">
          <label><input type="checkbox" class="lang-check" value="zh">ä¸­</label>
          <label><input type="checkbox" class="lang-check" value="en">è‹±</label>
        </div>
      </td>
      <td class="col-nation">
        <select class="nation-select" style="width:100%;">
          <option value="tw">ğŸ‡¹ğŸ‡¼ å°ç£</option>
          <option value="vn">ğŸ‡»ğŸ‡³ è¶Šå—</option>
          <option value="th">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
          <option value="id">ğŸ‡®ğŸ‡© å°å°¼</option>
        </select>
      </td>
      <td class="col-time">
        <div class="slots">
          <button type="button" class="add-slot" onclick="addSlot(this)">ï¼‹ æ–°å¢æ™‚æ®µ</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }

  function getNationInfo(nation, langs){
    let emoji='', lang='';
    if(nation==='tw') emoji='ğŸ‡¹ğŸ‡¼';
    if(nation==='vn') emoji='ğŸ‡»ğŸ‡³';
    if(nation==='th') emoji='ğŸ‡¹ğŸ‡­';
    if(nation==='id') emoji='ğŸ‡®ğŸ‡©';

    if(langs.includes('zh') && nation==='vn') lang='ä¸­è¶Šæ–‡æºé€š';
    else if(langs.includes('zh') && nation==='th') lang='ä¸­æ³°æ–‡æºé€š';
    else if(langs.includes('zh') && nation==='tw') lang='ä¸­æ–‡æºé€š';
    else if(langs.includes('en') && nation==='vn') lang='è‹±è¶Šæ–‡æºé€š';
    else if(langs.includes('en') && nation==='th') lang='è‹±æ³°æ–‡æºé€š';
    else if(nation==='vn') lang='è¶Šæ–‡æºé€š';
    else if(nation==='th') lang='æ³°æ–‡æºé€š';
    else if(nation==='id') lang='å°å°¼æ–‡æºé€š';
    return { emoji, lang };
  }

  function updateOutput(){
    const tbody = document.getElementById('girl-rows');
    let result = '';

    [...tbody.children].forEach(tr => {
      const name = tr.querySelector('.girl-name')?.value.trim() || '';
      if(!name) return;

      const room = tr.querySelector('.room-input')?.value.trim() || '';
      const langs = [...tr.querySelectorAll('.lang-check')].filter(x=>x.checked).map(x=>x.value);
      const nation = tr.querySelector('.nation-select')?.value || 'tw';
      const {emoji, lang} = getNationInfo(nation, langs);

      const slotsBox = tr.querySelector('.slots');
      const slotEls = slotsBox ? [...slotsBox.querySelectorAll('.slot')] : [];
      const lines = [];

      slotEls.forEach(s=>{
        const start = s.querySelector('.start')?.value || '';
        const dur = s.querySelector('.duration')?.value || '';
        if(start && dur){
          lines.push(`${start}/${dur}`);
        }
      });

      let head = `ğŸ’—${name} 11:00-01:00${emoji ? ' '+emoji : ''}â¡ï¸${lang ? lang : ''}${room ? ' ('+room+')' : ''}`;
      if(lines.length){
        result += head + '\n' + lines.join('\n') + '\n\n';
      }
    });

    document.getElementById('output-area').innerText = result.trim();
  }

  // äº‹ä»¶ç¶å®šï¼šæ‰€æœ‰è®Šæ›´éƒ½åˆ·æ–°å³å´
  document.getElementById('schedule-table').addEventListener('input', updateOutput);
  document.getElementById('schedule-table').addEventListener('change', updateOutput);
</script>
{% endblock %}