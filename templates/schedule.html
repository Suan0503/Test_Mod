{% extends 'admin_custom_master.html' %}
{% block body %}
<style>
  .schedule-wrap{ padding:24px 0; }
  .table-shell{ overflow:auto; border-radius:10px; background:#f7faff; padding:8px; }
  .schedule-table{ border-collapse:separate; border-spacing:0; width:100%; min-width:980px; table-layout:fixed; }
  .schedule-table th, .schedule-table td{ border:1px solid #b6d6ff; background:#fff; padding:10px; vertical-align:top; }
  .schedule-table thead th{ background:#eaf3ff; text-align:center; font-weight:600; }

  .col-girl{ width:300px; }
  .col-lang{ width:160px; }
  .col-nation{ width:160px; }
  .col-time{ min-width:560px; }

  .girl-box{ display:grid; grid-template-columns: 1fr 120px; gap:8px; }
  .lang-group{ display:flex; gap:12px; align-items:center; }
  .lang-group label{ display:inline-flex; gap:6px; align-items:center; }

  /* === 時間 chip 版 === */
  .time-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(86px, 1fr));
    gap:8px;
  }
  .slot-chip{ display:inline-flex; align-items:center; gap:6px; }
  .slot-chip input[type="checkbox"]{ display:none; } /* 用 label 當按鈕 */
  .chip{
    padding:6px 10px 6px 10px;
    border:1px solid #cfe1ff;
    border-radius:999px;
    background:#fff;
    cursor:pointer;
    font-variant-numeric: tabular-nums;
    user-select:none;
    position:relative;
    font-size:15px;
    letter-spacing:1px;
  }
  .chip .half-label{
    position:absolute;
    top:2px;
    right:8px;
    font-size:11px;
    color:#888;
    opacity:.7;
    pointer-events:none;
  }
  .slot-chip .dur{
    display:none;
    width:64px;
    padding:4px 6px;
  }
  /* 勾選後變色，並顯示方案 */
  .slot-chip input:checked + label.chip{
    background:#e8f1ff;
    border-color:#6aa1ff;
    box-shadow: 0 0 0 2px rgba(51,122,255,.08) inset;
  }
  .slot-chip input:checked + label.chip + select.dur{ display:inline-block; }

              <div class="time-grid">
                {% set times = [
                  '11:00','11:30','12:00','12:30',
                  '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30','05:00','05:30',
                  '06:00','06:30','07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30',
                  '11:00','11:30','12:00','12:30','01:00'
                ] %}
                {% for t in times %}
                  {% set id = 't_' ~ loop.index ~ '_' ~ range(1000,9999)|random %}
                  {% set chip_txt = t.replace(':','') %}
                  <span class="slot-chip">
                    <input id="{{ id }}" type="checkbox" class="time-ck" data-time="{{ chip_txt }}">
                    <label class="chip" for="{{ id }}">{{ chip_txt }}{% if t.endswith('30') %}<span class="half-label">+30</span>{% endif %}</label>
                    <select class="dur" aria-label="方案">
                      <option value="40">40</option>
                      <option value="60" selected>60</option>
                      <option value="90">90</option>
                    </select>
                  </span>
                {% endfor %}
              </div>

<div class="schedule-main" style="display:flex; gap:32px;">
  <div style="flex:1; min-width:420px;">
    <h3>排班表</h3>

    <div class="table-shell">
      <table class="schedule-table" id="schedule-table">
        <thead>
          <tr>
            <th class="col-girl">妹妹（名稱／房間號碼）</th>
            <th class="col-lang">語言</th>
            <th class="col-nation">國籍</th>
            <th class="col-time">時間</th>
          </tr>
        </thead>
        <tbody id="girl-rows">
          <!-- 多多 -->
          <tr>
            <td class="col-girl">
              <div class="girl-box">
                <input type="text" class="girl-name" value="多多" placeholder="名稱">
                <input type="text" class="room-input" value="501007" placeholder="房號">
              </div>
            </td>
            <td class="col-lang">
              <div class="lang-group">
                <label><input type="checkbox" class="lang-check" value="zh">中</label>
                <label><input type="checkbox" class="lang-check" value="en">英</label>
              </div>
            </td>
            <td class="col-nation">
              <select class="nation-select" style="width:100%;">
                <option value="tw">🇹🇼 台灣</option>
                <option value="vn">🇻🇳 越南</option>
                <option value="th">🇹🇭 泰國</option>
                <option value="id">🇮🇩 印尼</option>
              </select>
            </td>
            <td class="col-time">
              <div class="time-grid">
                {{ render_time_chips() }}
              </div>
            </td>
          </tr>

            </td>
            <td class="col-time">
              <div class="time-grid">
                {{ render_time_chips() }}
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <button class="add-girl-btn" onclick="addGirlRow()">新增妹妹</button>
  </div>

  <div style="flex:1; min-width:320px;">
    <h3>即時排班結果</h3>
    <div id="output-area"></div>
  </div>
</div>

{# ---- Jinja 小巨集：產出 chips ---- #}
{% macro render_time_chips() -%}
  {# 11:00→12:30→01:00（半小時一格） #}
  {% set times = [
    '11:00','11:30','12:00','12:30',
    '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30','05:00','05:30',
    '06:00','06:30','07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30',
    '11:00','11:30','12:00','12:30','01:00'
  ] %}
  {% for t in times %}
    {% set id = 't_' ~ loop.index ~ '_' ~ range(1000,9999)|random %}
    {% set chip_txt = t.replace(':','') %}
    <span class="slot-chip">
      <input id="{{ id }}" type="checkbox" class="time-ck" data-time="{{ chip_txt }}">
      <label class="chip" for="{{ id }}">{{ chip_txt }}{% if t.endswith('30') %}<span class="half-label">+30</span>{% endif %}</label>
      <select class="dur" aria-label="方案">
        <option value="40">40</option>
        <option value="60" selected>60</option>
        <option value="90">90</option>
      </select>
    </span>
  {% endfor %}
{%- endmacro %}

<script>
  // 產出 time chips 的 HTML（for 新增妹妹）
  const TIMES = [
    '11:00','11:30','12:00','12:30',
    '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30','05:00','05:30',
    '06:00','06:30','07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30',
    '11:00','11:30','12:00','12:30','01:00'
  ];
  function chipHTML(){
    return TIMES.map((t,i)=>{
      const id = `t_${i}_${Math.floor(1000+Math.random()*9000)}`;
      const chip_txt = t.replace(':','');
      const plus30 = t.endsWith('30') ? '<span class="half-label">+30</span>' : '';
      return `
        <span class="slot-chip">
          <input id="${id}" type="checkbox" class="time-ck" data-time="${chip_txt}">
          <label class="chip" for="${id}">${chip_txt}${plus30}</label>
          <select class="dur">
            <option value="40">40</option>
            <option value="60" selected>60</option>
            <option value="90">90</option>
          </select>
        </span>`;
    }).join('');
  }

  function addGirlRow(){
    const tbody = document.getElementById('girl-rows');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-girl">
        <div class="girl-box">
          <input type="text" class="girl-name" placeholder="名稱">
          <input type="text" class="room-input" placeholder="房號">
        </div>
      </td>
      <td class="col-lang">
        <div class="lang-group">
          <label><input type="checkbox" class="lang-check" value="zh">中</label>
          <label><input type="checkbox" class="lang-check" value="en">英</label>
        </div>
      </td>
      <td class="col-nation">
        <select class="nation-select" style="width:100%;">
          <option value="tw">🇹🇼 台灣</option>
          <option value="vn">🇻🇳 越南</option>
          <option value="th">🇹🇭 泰國</option>
          <option value="id">🇮🇩 印尼</option>
        </select>
      </td>
      <td class="col-time">
        <div class="time-grid">${chipHTML()}</div>
      </td>`;
    tbody.appendChild(tr);
  }

  function getNationInfo(nation, langs){
    let emoji='', lang='';
    if(nation==='tw') emoji='🇹🇼';
    if(nation==='vn') emoji='🇻🇳';
    if(nation==='th') emoji='🇹🇭';
    if(nation==='id') emoji='🇮🇩';
    if(langs.includes('zh') && nation==='vn') lang='中越文溝通';
    else if(langs.includes('zh') && nation==='th') lang='中泰文溝通';
    else if(langs.includes('zh') && nation==='tw') lang='中文溝通';
    else if(langs.includes('en') && nation==='vn') lang='英越文溝通';
    else if(langs.includes('en') && nation==='th') lang='英泰文溝通';
    else if(nation==='vn') lang='越文溝通';
    else if(nation==='th') lang='泰文溝通';
    else if(nation==='id') lang='印尼文溝通';
    return { emoji, lang };
  }

  function updateOutput(){
    const tbody = document.getElementById('girl-rows');
    let result = '';

    [...tbody.children].forEach(tr=>{
      const name = tr.querySelector('.girl-name')?.value.trim();
      if(!name) return;
      const room = tr.querySelector('.room-input')?.value.trim() || '';
      const langs = [...tr.querySelectorAll('.lang-check')].filter(x=>x.checked).map(x=>x.value);
      const nation = tr.querySelector('.nation-select')?.value || 'tw';
      const {emoji, lang} = getNationInfo(nation, langs);

      const lines = [];
      tr.querySelectorAll('.time-ck').forEach(ck=>{
        if(ck.checked){
          const dur = ck.parentElement.querySelector('.dur')?.value || '60';
          lines.push(`${ck.dataset.time}/${dur}`);
        }
      });

      let head = `💗${name} 11:00-01:00${emoji ? ' '+emoji : ''}➡️${lang ? lang : ''}${room ? ' ('+room+')' : ''}`;
      if(lines.length){
        result += head + '\n' + lines.join('\n') + '\n\n';
      }
    });

    document.getElementById('output-area').innerText = result.trim();
  }

  // 任何變動就更新輸出
  document.getElementById('schedule-table').addEventListener('input', updateOutput);
  document.getElementById('schedule-table').addEventListener('change', updateOutput);
</script>
{% endblock %}