{% extends 'admin_custom_master.html' %}
{% block body %}
<style>
  .schedule-table { border-collapse: collapse; width:100%; }
  .schedule-table th, .schedule-table td { border:1px solid #b6d6ff; padding:8px; text-align:center; }
  .schedule-table th { background:#e3f2fd; }
  .girl-name, .room-input { width:80px; display:block; margin:2px auto; }
  .lang-check { margin:0 4px; }
  .time-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .time-select, .duration-select { width: 90px; }
  .remove-time-btn { background: #f04747; color: #fff; border: none; border-radius: 6px; padding: 2px 8px; cursor: pointer; }
  .add-time-btn, .sort-time-btn { margin: 8px 4px; padding: 4px 12px; border-radius: 6px; border: none; background: #4f8cff; color: #fff; cursor: pointer; }
  .copy-btn { margin-bottom: 12px; padding: 6px 18px; border-radius: 6px; border: none; background: #38c6ff; color: #fff; cursor: pointer; font-weight: 600; }
  .result-header { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
  .result-sep { color: #1976d2; margin: 8px 0; }
</style>

<div class="schedule-main" style="display:flex;gap:32px;padding:32px 0;">
  <div style="flex:1;">
    <h3>æ’ç­è¡¨</h3>
    <table class="schedule-table" id="schedule-table">
      <thead>
        <tr>
          <th>å¦¹å¦¹<br><small>ï¼ˆåç¨±ï¼‹æˆ¿è™Ÿï¼‰</small></th>
          <th>èªè¨€</th>
          <th>åœ‹ç±</th>
          <th>æ™‚é–“
            <button class="sort-time-btn" onclick="sortAllTimes()">åˆ·æ–°æ’åº</button>
          </th>
        </tr>
      </thead>
  <tbody id="girl-rows">
  </tbody>
    </table>
    {% if can_edit %}
    <button class="add-girl-btn" onclick="addGirlRow()" style="margin-top:12px;">æ–°å¢å¦¹å¦¹</button>
    {% endif %}
  </div>

  <div style="flex:1;">
    <h3>å³æ™‚æ’ç­çµæœ</h3>
    <div class="result-header">
      <span id="guest-count">ç¸½å®¢æ•¸ï¼š0</span>
      <button class="copy-btn" onclick="copyScheduleResult()">ä¸€éµè¤‡è£½</button>
    </div>
    <div id="output-area" style="background:#f7f9fe;border-radius:8px;min-height:400px;padding:16px;font-size:16px;white-space:pre-line;"></div>
  </div>
</div>

<script>
const canEdit = {{ can_edit|tojson|safe }};
// const SCHEDULE_KEY = 'schedule_temp_v1'; // å·²ä¸ä½¿ç”¨æœ¬åœ°æš«å­˜

// åŠå°æ™‚ä¸€æ ¼
const timeOptions = [];
for(let h=11;h<=23;h++){
  timeOptions.push(`${String(h).padStart(2,'0')}:00`);
  timeOptions.push(`${String(h).padStart(2,'0')}:30`);
}
timeOptions.push('00:00');
timeOptions.push('00:30');
timeOptions.push('01:00');
const durationOptions = ['40','60','90'];

function getTodayStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const weekMap = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const week = weekMap[d.getDay()];
  return `${y}-${m}-${day} æ˜ŸæœŸ${week} é ç´„è¡¨`;
}

// å¤šäººåŒæ­¥ï¼šè¼‰å…¥æ™‚è‡ªå‹• fetch æœ€æ–°ç­è¡¨
let isEditing = false;
function fetchAndUpdateSchedule() {
  if (isEditing) return; // è‹¥æ­£åœ¨ç·¨è¼¯ï¼Œä¸è‡ªå‹•è¦†è“‹
  fetch('/api/schedule').then(r=>r.json()).then(data=>{
    if(data && Object.keys(data).length) {
      loadScheduleFromServer(data);
    }
  });
}
window.addEventListener('DOMContentLoaded',()=>{
  fetchAndUpdateSchedule();
  autoSaveSchedule();
  setInterval(fetchAndUpdateSchedule, 10000);
});

function loadScheduleFromServer(data) {
  const tbody = document.getElementById('girl-rows');
  tbody.innerHTML = '';
  for(const girl of data.girls||[]) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="text" class="girl-name" value="${girl.name}" placeholder="åç¨±" ${canEdit ? '' : 'readonly'}>
        <input type="text" class="room-input" value="${girl.room}" placeholder="æˆ¿è™Ÿ" ${canEdit ? '' : 'readonly'}>
      </td>
      <td>
        <label><input type="checkbox" class="lang-check" value="zh" ${girl.langs&&girl.langs.includes('zh')?'checked':''} ${canEdit ? '' : 'disabled'}>ä¸­</label>
        <label><input type="checkbox" class="lang-check" value="en" ${girl.langs&&girl.langs.includes('en')?'checked':''} ${canEdit ? '' : 'disabled'}>è‹±</label>
      </td>
      <td>
        <select class="nation-select" style="width:90px;" ${canEdit ? '' : 'disabled'}>
          <option value="tw"${girl.nation==='tw'?' selected':''}>ğŸ‡¹ğŸ‡¼ å°ç£</option>
          <option value="vn"${girl.nation==='vn'?' selected':''}>ğŸ‡»ğŸ‡³ è¶Šå—</option>
          <option value="th"${girl.nation==='th'?' selected':''}>ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
          <option value="id"${girl.nation==='id'?' selected':''}>ğŸ‡®ğŸ‡© å°å°¼</option>
        </select>
      </td>
      <td>
        <div class="times-list"></div>
        ${canEdit ? '<button class="add-time-btn" onclick="addTimeRow(this)">æ–°å¢æ™‚æ®µ</button>' : ''}
      </td>
    `;
    tbody.appendChild(tr);
    // æ™‚æ®µ
    const timesList = tr.querySelector('.times-list');
    for(const t of girl.times||[]) {
      const div = document.createElement('div');
      div.className = 'time-row';
      div.innerHTML = `
        <select class="time-select">
          ${timeOptions.map(opt=>`<option value="${opt}"${opt===t.time?' selected':''}>${opt}</option>`).join('')}
        </select>
        <select class="duration-select">
          <option value="40"${t.dur==='40'?' selected':''}>40</option>
          <option value="60"${t.dur==='60'?' selected':''}>60</option>
          <option value="90"${t.dur==='90'?' selected':''}>90</option>
        </select>
        ${canEdit ? '<button class="remove-time-btn" onclick="removeTimeRow(this)">åˆªé™¤</button>' : ''}
      `;
      timesList.appendChild(div);
    }
  }
  getScheduleResult();
}

// ç®¡ç†å“¡/è¶…ç´šç®¡ç†å“¡æ“ä½œæ™‚è‡ªå‹• POST æ›´æ–°
function saveScheduleToServer() {
  if(!canEdit) return;
  isEditing = true;
  const tbody = document.getElementById('girl-rows');
  const data = { girls: [] };
  for (const tr of tbody.children) {
    const name = tr.querySelector('.girl-name').value.trim();
    const room = tr.querySelector('.room-input').value.trim();
    const langChecks = tr.querySelectorAll('.lang-check');
    const langs = Array.from(langChecks).filter(c => c.checked).map(c => c.value);
    const nation = tr.querySelector('.nation-select').value;
    const timesList = tr.querySelector('.times-list');
    const times = [];
    if(timesList) {
      for(const timeRow of timesList.children) {
        const time = timeRow.querySelector('.time-select').value;
        const dur = timeRow.querySelector('.duration-select').value;
        times.push({time, dur});
      }
    }
    data.girls.push({name, room, langs, nation, times});
  }
  fetch('/api/schedule', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({data})
  }).finally(()=>{
    setTimeout(()=>{ isEditing = false; }, 1000); // 1ç§’å¾Œå…è¨±è‡ªå‹•åŒæ­¥
  });
}
// ç›£è½æ‰€æœ‰æ“ä½œè‡ªå‹•åŒæ­¥
function autoSaveSchedule() {
  if(!canEdit) return;
  document.getElementById('girl-rows').addEventListener('input', saveScheduleToServer);
  document.getElementById('girl-rows').addEventListener('change', saveScheduleToServer);
}

function addTimeRow(btn) {
  if(!canEdit) return;
  const timesList = btn.parentNode.querySelector('.times-list');
  const div = document.createElement('div');
  div.className = 'time-row';
  let nextTime = '11:00';
  if(timesList.children.length > 0) {
    const lastRow = timesList.lastElementChild;
    const lastSelect = lastRow.querySelector('.time-select');
    const lastDur = lastRow.querySelector('.duration-select').value;
    // å–å¾—ä¸Šä¸€æ™‚æ®µçš„é–‹å§‹æ™‚é–“
    let [h,m] = lastSelect.value.split(':').map(Number);
    let dur = parseInt(lastDur);
    if(dur === 90) {
      m += 90;
    } else if(dur === 60) {
      m += 60;
    } else if(dur === 40) {
      // 40åˆ†é˜ç›´æ¥è·³åˆ°ä¸‹ä¸€å€‹æ•´é»æˆ–åŠé»
      if(m === 0) m = 30;
      else { h++; m = 0; }
    }
    // è™•ç†åˆ†é˜æº¢ä½
    if(m >= 60) { h += Math.floor(m/60); m = m%60; }
    // æ‰¾æœ€è¿‘çš„å¯é¸æ™‚é–“
    let candidate = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    let idx = timeOptions.indexOf(candidate);
    if(idx === -1) {
      // è‹¥ä¸æ˜¯æ•´é»æˆ–åŠé»ï¼Œæ‰¾ä¸‹ä¸€å€‹å¯é¸
      let allTimes = timeOptions.concat();
      allTimes.push(candidate);
      allTimes.sort();
      idx = allTimes.indexOf(candidate)+1;
      candidate = timeOptions[idx] || timeOptions[0];
    }
    nextTime = candidate;
  }
  div.innerHTML = `
    <select class="time-select">
      ${timeOptions.map(t=>`<option value="${t}"${t===nextTime?' selected':''}>${t}</option>`).join('')}
    </select>
    <select class="duration-select">
      <option value="40">40</option>
      <option value="60" selected>60</option>
      <option value="90">90</option>
    </select>
    <button class="remove-time-btn" onclick="removeTimeRow(this)">åˆªé™¤</button>
  `;
  timesList.appendChild(div);
  getScheduleResult();
}
function removeTimeRow(btn) {
  if(!canEdit) return;
  btn.parentNode.remove();
  getScheduleResult();
}
function addGirlRow() {
  if(!canEdit) return;
  const tbody = document.getElementById('girl-rows');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <input type="text" class="girl-name" placeholder="åç¨±">
      <input type="text" class="room-input" placeholder="æˆ¿è™Ÿ">
    </td>
    <td>
      <label><input type="checkbox" class="lang-check" value="zh">ä¸­</label>
      <label><input type="checkbox" class="lang-check" value="en">è‹±</label>
    </td>
    <td>
      <select class="nation-select" style="width:90px;">
        <option value="tw">ğŸ‡¹ğŸ‡¼ å°ç£</option>
        <option value="vn">ğŸ‡»ğŸ‡³ è¶Šå—</option>
        <option value="th">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
        <option value="id">ğŸ‡®ğŸ‡© å°å°¼</option>
      </select>
    </td>
    <td>
      <div class="times-list"></div>
      <button class="add-time-btn" onclick="addTimeRow(this)">æ–°å¢æ™‚æ®µ</button>
    </td>
  `;
  tbody.appendChild(tr);
  getScheduleResult();
}
function sortAllTimes() {
  const tbody = document.getElementById('girl-rows');
  for(const tr of tbody.children) {
    const timesList = tr.querySelector('.times-list');
    if(!timesList) continue;
    const rows = Array.from(timesList.children);
    rows.sort((a,b)=>{
      const ta = a.querySelector('.time-select').value;
      const tb = b.querySelector('.time-select').value;
      return timeOptions.indexOf(ta) - timeOptions.indexOf(tb);
    });
    rows.forEach(r=>timesList.appendChild(r));
  }
  getScheduleResult();
}
function getNationInfo(nation, langs) {
  let emoji = '', lang = '';
  if (nation === 'tw') emoji = 'ğŸ‡¹ğŸ‡¼';
  if (nation === 'vn') emoji = 'ğŸ‡»ğŸ‡³';
  if (nation === 'th') emoji = 'ğŸ‡¹ğŸ‡­';
  if (nation === 'id') emoji = 'ğŸ‡®ğŸ‡©';

  if (langs.includes('zh') && nation === 'vn') lang = 'ä¸­è¶Šæ–‡æºé€š';
  else if (langs.includes('zh') && nation === 'th') lang = 'ä¸­æ³°æ–‡æºé€š';
  else if (langs.includes('zh') && nation === 'tw') lang = 'ä¸­æ–‡æºé€š';
  else if (langs.includes('en') && nation === 'vn') lang = 'è‹±è¶Šæ–‡æºé€š';
  else if (langs.includes('en') && nation === 'th') lang = 'è‹±æ³°æ–‡æºé€š';
  else if (nation === 'vn') lang = 'è¶Šæ–‡æºé€š';
  else if (nation === 'th') lang = 'æ³°æ–‡æºé€š';
  else if (nation === 'id') lang = 'å°å°¼æ–‡æºé€š';
  else lang = '';
  return { emoji, lang };
}
function getScheduleResult() {
  const tbody = document.getElementById('girl-rows');
  let result = '';
  let copyText = getTodayStr()+'\n';
  let guestCount = 0;
  for (const tr of tbody.children) {
    const name = tr.querySelector('.girl-name').value.trim();
    const room = tr.querySelector('.room-input').value.trim();
    const langChecks = tr.querySelectorAll('.lang-check');
    const langs = Array.from(langChecks).filter(c => c.checked).map(c => c.value);
    const nation = tr.querySelector('.nation-select').value;
    const nationInfo = getNationInfo(nation, langs);
    if (!name) continue;
    let line = `ğŸ’—${name} ${nationInfo.emoji} ${nationInfo.lang}${room ? ' ('+room+')' : ''}`;
    let slots = [];
    const timesList = tr.querySelector('.times-list');
    if(timesList) {
      for(const timeRow of timesList.children) {
        const time = timeRow.querySelector('.time-select').value;
        const dur = timeRow.querySelector('.duration-select').value;
        if(time && dur) {
          slots.push(`${time}/${dur}`);
          guestCount++;
        }
      }
    }
    if (slots.length) {
      line += '\n' + slots.join('\n');
      result += line + '\n<div class="result-sep">------------</div>\n';
      copyText += line + '\n------------\n';
    }
  }
  document.getElementById('output-area').innerHTML = result.trim();
  document.getElementById('guest-count').innerText = `ç¸½å®¢æ•¸ï¼š${guestCount}`;
  window._copyScheduleText = copyText.trim();
}
function copyScheduleResult() {
  if(window._copyScheduleText) {
    navigator.clipboard.writeText(window._copyScheduleText);
    alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
  }
}

// æš«å­˜ key
// ...existing code...


function getNationInfo(nation, langs) {
  let emoji = '', lang = '';
  if (nation === 'tw') emoji = 'ğŸ‡¹ğŸ‡¼';
  if (nation === 'vn') emoji = 'ğŸ‡»ğŸ‡³';
  if (nation === 'th') emoji = 'ğŸ‡¹ğŸ‡­';
  if (nation === 'id') emoji = 'ğŸ‡®ğŸ‡©';

  if (langs.includes('zh') && nation === 'vn') lang = 'ä¸­è¶Šæ–‡æºé€š';
  else if (langs.includes('zh') && nation === 'th') lang = 'ä¸­æ³°æ–‡æºé€š';
  else if (langs.includes('zh') && nation === 'tw') lang = 'ä¸­æ–‡æºé€š';
  else if (langs.includes('en') && nation === 'vn') lang = 'è‹±è¶Šæ–‡æºé€š';
  else if (langs.includes('en') && nation === 'th') lang = 'è‹±æ³°æ–‡æºé€š';
  else if (nation === 'vn') lang = 'è¶Šæ–‡æºé€š';
  else if (nation === 'th') lang = 'æ³°æ–‡æºé€š';
  else if (nation === 'id') lang = 'å°å°¼æ–‡æºé€š';
  else lang = '';
  return { emoji, lang };
}
function getScheduleResult() {
  const tbody = document.getElementById('girl-rows');
  let result = '';
  let copyText = getTodayStr()+'\n';
  let guestCount = 0;
  for (const tr of tbody.children) {
    const name = tr.querySelector('.girl-name').value.trim();
    const room = tr.querySelector('.room-input').value.trim();
    const langChecks = tr.querySelectorAll('.lang-check');
    const langs = Array.from(langChecks).filter(c => c.checked).map(c => c.value);
    const nation = tr.querySelector('.nation-select').value;
    const nationInfo = getNationInfo(nation, langs);
    if (!name) continue;
    let line = `ğŸ’—${name} ${nationInfo.emoji} ${nationInfo.lang}${room ? ' ('+room+')' : ''}`;
    let slots = [];
    const timesList = tr.querySelector('.times-list');
    if(timesList) {
      for(const timeRow of timesList.children) {
        const time = timeRow.querySelector('.time-select').value;
        const dur = timeRow.querySelector('.duration-select').value;
        if(time && dur) {
          slots.push(`${time}/${dur}`);
          guestCount++;
        }
      }
    }
    if (slots.length) {
      line += '\n' + slots.join('\n');
      result += line + '\n<div class="result-sep">------------</div>\n';
      copyText += line + '\n------------\n';
    }
  }
  document.getElementById('output-area').innerHTML = result.trim();
  document.getElementById('guest-count').innerText = `ç¸½å®¢æ•¸ï¼š${guestCount}`;
  window._copyScheduleText = copyText.trim();
}
function copyScheduleResult() {
  if(window._copyScheduleText) {
    navigator.clipboard.writeText(window._copyScheduleText);
    alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
  }
}


</script>
{% endblock %}