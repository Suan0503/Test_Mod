{% extends 'admin_custom_master.html' %}
{% block body %}
<style>
  .schedule-wrap{ padding:24px 0; }
  .table-shell{ overflow:auto; border-radius:10px; background:#f7faff; padding:8px; }
  .schedule-table{ border-collapse:separate; border-spacing:0; width:100%; min-width:980px; table-layout:fixed; }
  .schedule-table th, .schedule-table td{ border:1px solid #b6d6ff; background:#fff; padding:10px; vertical-align:top; }
  .schedule-table thead th{ background:#eaf3ff; text-align:center; font-weight:600; }
  .col-girl{ width:280px; }
  .col-lang{ width:160px; }
  .col-nation{ width:160px; }
  .col-time{ min-width:480px; }

  /* 妹妹欄位 */
  .girl-box{ display:grid; grid-template-columns: 1fr 120px; gap:8px; align-items:center; }
  .girl-box input[type="text"]{ width:100%; }
  .room-input{ width:100%; }

  /* 語言 */
  .lang-group{ display:flex; gap:12px; align-items:center; }
  .lang-group label{ display:inline-flex; align-items:center; gap:6px; }

  /* 時段編輯 */
  .slots{ display:flex; flex-direction:column; gap:8px; }
  .slot{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .slot select{ width:110px; }
  .slot .remove{ border:none; background:#ffe5e5; color:#c0392b; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .add-slot{ border:none; background:#e7f3ff; color:#1a73e8; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .add-girl-btn{ margin-top:12px; }

  /* 右側輸出 */
  #output-area{ background:#f7f9fe; border-radius:8px; min-height:420px; padding:16px; font-size:15px; white-space:pre-line; }
</style>

<div class="schedule-main" style="display:flex; gap:32px;" >
  <div style="flex:1; min-width:420px;">
    <h3>排班表</h3>

    <div class="table-shell">
      <table class="schedule-table" id="schedule-table">
        <thead>
          <tr>
            <th class="col-girl">妹妹（名稱／房間號碼）</th>
            <th class="col-lang">語言</th>
            <th class="col-nation">國籍</th>
            <th class="col-time">時間</th>
          </tr>
        </thead>
        <tbody id="girl-rows">
          <!-- 多多 -->
          <tr>
            <td class="col-girl">
              <div class="girl-box">
                <input type="text" class="girl-name" value="多多" placeholder="名稱">
                <input type="text" class="room-input" value="501007" placeholder="房號">
              </div>
            </td>
            <td class="col-lang">
              <div class="lang-group">
                <label><input type="checkbox" class="lang-check" value="zh">中</label>
                <label><input type="checkbox" class="lang-check" value="en">英</label>
              </div>
            </td>
            <td class="col-nation">
              <select class="nation-select" style="width:100%;">
                <option value="tw">🇹🇼 台灣</option>
                <option value="vn">🇻🇳 越南</option>
                <option value="th">🇹🇭 泰國</option>
                <option value="id">🇮🇩 印尼</option>
              </select>
            </td>
            <td class="col-time">
              <div class="slots">
                <!-- 初始給一個時段 -->
                <div class="slot">
                  <select class="start">
                    <!-- 11:00 ～ 01:30（半小時一格） -->
                    {% set starts = [
                      '11:00','11:30','12:00','12:30',
                      '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30','05:00','05:30',
                      '06:00','06:30','07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30',
                      '11:00','11:30','12:00','12:30','01:00'
                    ] %}
                    {% for s in starts %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                  </select>
                  <select class="duration">
                    <option value="">方案</option>
                    <option value="40">40</option>
                    <option value="60" selected>60</option>
                    <option value="90">90</option>
                  </select>
                  <button type="button" class="remove" onclick="removeSlot(this)">刪除</button>
                </div>
                <button type="button" class="add-slot" onclick="addSlot(this)">＋ 新增時段</button>
              </div>
            </td>
          </tr>

          <!-- 莎莎 -->
          <tr>
            <td class="col-girl">
              <div class="girl-box">
                <input type="text" class="girl-name" value="莎莎" placeholder="名稱">
                <input type="text" class="room-input" value="" placeholder="房號">
              </div>
            </td>
            <td class="col-lang">
              <div class="lang-group">
                <label><input type="checkbox" class="lang-check" value="zh">中</label>
                <label><input type="checkbox" class="lang-check" value="en">英</label>
              </div>
            </td>
            <td class="col-nation">
              <select class="nation-select" style="width:100%;">
                <option value="tw">🇹🇼 台灣</option>
                <option value="vn">🇻🇳 越南</option>
                <option value="th">🇹🇭 泰國</option>
                <option value="id">🇮🇩 印尼</option>
              </select>
            </td>
            <td class="col-time">
              <div class="slots">
                <button type="button" class="add-slot" onclick="addSlot(this)">＋ 新增時段</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <button class="add-girl-btn" onclick="addGirlRow()">新增妹妹</button>
  </div>

  <div style="flex:1; min-width:320px;">
    <h3>即時排班結果</h3>
    <div id="output-area"></div>
  </div>
</div>

<script>
  // 可選開始時間（半小時一格）
  const STARTS = [
    '11:00','11:30','12:00','12:30',
    '01:00','01:30','02:00','02:30','03:00','03:30','04:00','04:30','05:00','05:30',
    '06:00','06:30','07:00','07:30','08:00','08:30','09:00','09:30','10:00','10:30',
    '11:00','11:30','12:00','12:30','01:00'
  ];

  function slotTemplate(){
    const startOptions = STARTS.map(s => `<option value="${s}">${s}</option>`).join('');
    return `
      <div class="slot">
        <select class="start">${startOptions}</select>
        <select class="duration">
          <option value="">方案</option>
          <option value="40">40</option>
          <option value="60">60</option>
          <option value="90">90</option>
        </select>
        <button type="button" class="remove" onclick="removeSlot(this)">刪除</button>
      </div>`;
  }

  function addSlot(btn){
    const slotsBox = btn.closest('.slots');
    // 按鈕永遠放在最後，插在按鈕前面
    btn.insertAdjacentHTML('beforebegin', slotTemplate());
    updateOutput();
  }

  function removeSlot(el){
    const slot = el.closest('.slot');
    slot.remove();
    updateOutput();
  }

  function addGirlRow(){
    const tbody = document.getElementById('girl-rows');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-girl">
        <div class="girl-box">
          <input type="text" class="girl-name" value="" placeholder="名稱">
          <input type="text" class="room-input" value="" placeholder="房號">
        </div>
      </td>
      <td class="col-lang">
        <div class="lang-group">
          <label><input type="checkbox" class="lang-check" value="zh">中</label>
          <label><input type="checkbox" class="lang-check" value="en">英</label>
        </div>
      </td>
      <td class="col-nation">
        <select class="nation-select" style="width:100%;">
          <option value="tw">🇹🇼 台灣</option>
          <option value="vn">🇻🇳 越南</option>
          <option value="th">🇹🇭 泰國</option>
          <option value="id">🇮🇩 印尼</option>
        </select>
      </td>
      <td class="col-time">
        <div class="slots">
          <button type="button" class="add-slot" onclick="addSlot(this)">＋ 新增時段</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }

  function getNationInfo(nation, langs){
    let emoji='', lang='';
    if(nation==='tw') emoji='🇹🇼';
    if(nation==='vn') emoji='🇻🇳';
    if(nation==='th') emoji='🇹🇭';
    if(nation==='id') emoji='🇮🇩';

    if(langs.includes('zh') && nation==='vn') lang='中越文溝通';
    else if(langs.includes('zh') && nation==='th') lang='中泰文溝通';
    else if(langs.includes('zh') && nation==='tw') lang='中文溝通';
    else if(langs.includes('en') && nation==='vn') lang='英越文溝通';
    else if(langs.includes('en') && nation==='th') lang='英泰文溝通';
    else if(nation==='vn') lang='越文溝通';
    else if(nation==='th') lang='泰文溝通';
    else if(nation==='id') lang='印尼文溝通';
    return { emoji, lang };
  }

  function updateOutput(){
    const tbody = document.getElementById('girl-rows');
    let result = '';

    [...tbody.children].forEach(tr => {
      const name = tr.querySelector('.girl-name')?.value.trim() || '';
      if(!name) return;

      const room = tr.querySelector('.room-input')?.value.trim() || '';
      const langs = [...tr.querySelectorAll('.lang-check')].filter(x=>x.checked).map(x=>x.value);
      const nation = tr.querySelector('.nation-select')?.value || 'tw';
      const {emoji, lang} = getNationInfo(nation, langs);

      const slotsBox = tr.querySelector('.slots');
      const slotEls = slotsBox ? [...slotsBox.querySelectorAll('.slot')] : [];
      const lines = [];

      slotEls.forEach(s=>{
        const start = s.querySelector('.start')?.value || '';
        const dur = s.querySelector('.duration')?.value || '';
        if(start && dur){
          lines.push(`${start}/${dur}`);
        }
      });

      let head = `💗${name} 11:00-01:00${emoji ? ' '+emoji : ''}➡️${lang ? lang : ''}${room ? ' ('+room+')' : ''}`;
      if(lines.length){
        result += head + '\n' + lines.join('\n') + '\n\n';
      }
    });

    document.getElementById('output-area').innerText = result.trim();
  }

  // 事件綁定：所有變更都刷新右側
  document.getElementById('schedule-table').addEventListener('input', updateOutput);
  document.getElementById('schedule-table').addEventListener('change', updateOutput);
</script>
{% endblock %}